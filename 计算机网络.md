# 计算机网络

## 一、概论

### 1、网络、互联网和因特网

**网络（Network）由若干结点（Node）和连接这些结点的链路（Link）组成**

**多个网络可以通过路由器互连起来，这样就构成了一个范围更大的网络，即互联网。因此互联网是网络的网络**

**因特网（Internet）是世界上最大的互连网络，用户数以亿计**

注：internet（互联网或互连网）是一个通用名词，泛指多个计算机网络互连形成的网络，**它们的通信协议可以是任意的**

而Internet（因特网）是一个专用名词，是最大的互连网络，采用TCP/IP协议簇作为通信规则

#### **因特网发展的三个阶段：**

1969年，美国第一个分组交换网ARPANET（单个的分组交换网），不是互连的网络。

1983年，TCP/IP协议成为ARPANET的标准协议**（因特网诞生时间）**

1994年，WWW技术推动因特网迅速发展

#### **因特网服务提供者（Internet Service Provider，ISP）**

ISP从因特网管理机构申请到很多IP地址，同时拥有通信线路及路由器等联网设备。普通用户需要向ISP缴纳固定费用才能接入因特网，得到IP地址。我国的ISP是三大运营商。

因特网的标准化工作是面向公众的，其任何一个建议标准在成为因特网标准之前都以RFC（request for comments，请求评论）技术文档的形式在因特网上发表。

**因特网已发展成为基于ISP的多层次结构的互连网络**

![ISP三层结构](D:\office\word\计算机基础\计算机网络\截图\ISP三层结构.png)

#### **因特网的组成：**

- **边缘部分** 由所有连接在因特网上的主机组成，**由用户直接使用**，可以进行通信（传输数据）和资源共享

这些主机又被称为端系统（end system）。端即末端，主机A和主机B通信**实际上是指运行在主机A上的某个程序（进程）和运行在主机B上的某个程序（进程）进行通信。**简称计算机通信

在网络边缘的端系统之间的通信方式通常分为两大类：**客户—服务器方式（C/S）和对等方式（P2P，peer to peer）。**

​		C/S方式是因特网最常用的，也是传统方式。客户和服务器都是指通信中所涉及的两个应用进程，它描述的进程之间服务和被服务的关系。**客户是服务请求方，服务器是服务提供方**。它们都需要使用核心部分所提供的服务

​		**对等连接方式（P2P）**是指两个主机通信时不区分服务请求方和提供方，只要两个主机都运行对等连接软件即可平等、对等连接通信。

对等方式它的实质仍然是C/S方式，只是它的每个主机既是客户也是服务器

主机接入核心部分通常以相对低速的链路连接



- **核心部分** 由大量网络和连接这些网络的路由器组成，**为边缘部分提供服务（提供连通性和交换）**

在因特网核心部分起特殊作用的是**路由器（router）**，它是一种专用计算机但不是主机，**是实现分组交换（packet switching）的关键构件**，它的任务是**转发收到的分组。**这是网络核心部分最重要的功能

因特网核心部分的路由器之间一般使用高速链路相连接

**主机为用户进行信息处理，和其他主机通过网络交换信息；路由器是用来转发分组的，即进行分组交换**

### 2、三种数据交换方式

#### 电路交换（circuit switching）

出现电话之后，人们发现让所有电话机两两相连是不现实的，n部电话两两相连需要n(n-1)/2条电线。

为了方便电话之间的通信，应该使用**电话交换机**将电话连接起来，每一部电话都连接到交换机上，**交换机的交换方式是电路交换**。我们需要使用很多彼此连接的交换机来完成全网的交换任务，这种方式就构成了覆盖全球的电信网

![电话交换机](D:\office\word\计算机基础\计算机网络\截图\电话交换机.jpg)

**从通信资源分配的角度来说，交换就是按照某种方式动态地分配传输线路的资源。**

**电路交换步骤：**

​		1、建立连接（建立专用的物理通路，占用通信资源）

​		2、通话（一直占用资源）

​		3、释放连接（归还通信资源）

**电路交换特征：在通话的全部时间内，通话的两个用户始终占用端到端的通信资源。**适合数据量很大的实时性传输

电路交换传送计算机数据时它线路的传输效率往往很低，因为计算机数据是突发式地出现在传输线路上的，线路上真正用来传输数据的时间往往不到10%甚至是1%。

已被用户占用的通信线路资源很大部分时间会是空闲状态

**连续传送大量的数据，且传送时间远大于连接建立时间，则电路交换的传输速率较快**

#### 分组交换（packet switching）

- 分组交换采用存储转发技术

- **我们将要发送的整块数据叫作一个报文（message）**

- 发送报文之前需要先把较长的报文划分为一个个等长的数据段，**在每一个数据段之前加上必要的控制信息组成的首部（header）之后，就构成了一个分组（packet），也叫作包，首部也叫作包头。**

- **分组是在因特网中传送的数据单元**

- 首部包含了目的地址和源地址等重要控制信息，可以独立地选择传输路径并被正确交付到终点
- **分组交换不必占用一条端到端的通信资源，它是一段段地断续占用通信链路资源，省去了建立和释放连接的开销，数据传输效率更高**

![](D:\office\word\计算机基础\计算机网络\截图\报文.jpg)

**路由器分组交换过程：**

路由器收到一个分组，先**暂时存储一下**，检查其首部，查找转发表，按照目的地址找到合适的接口将该分组转发到下一个路由器，这样不断地存储转发，直到交付最终的目的主机。

**路由器之间必须经常交换各自的路由信息，以便创建和维持在路由器中的转发表，使得转发表及时更新**

**路由器暂存的是一个个短分组，不是整个的长报文。**

**短分组是暂存在路由器的存储器（内存）中而不是磁盘，可以保证较高的交换速率**

![](D:\office\word\计算机基础\计算机网络\截图\网络核心部分.jpg)

如上图b，单个网络往往简化为一条链路，路由器成为核心部分的结点，这种简化图看起来可以更加突出重点，可以知道路由器之间是怎样连接起来的

**因特网可以容许非常多的主机同时进行通信，一个主机中的多个进程也可以各自和不同主机中的不同进程进行通信**

**注意：**

- 分组交换在传送数据之前不必先占用一条端到端的通信资源。分组在哪一段链路上传送才占用这段链路的资源，即对通信链路的逐段占用

- 分组在传输时就一段段地断续占用通信资源，省去了建立连接和释放连接的开销，因此传输效率更高
- 当网络中的某些结点或链路突发故障时，在各路由器中运行的**路由选择协议**能自动找到其他路径转发分组

**采用存储转发的分组交换实质上采用了在数据通信的过程中断续（或动态）分配传输带宽的策略。这对传送突发式的计算机数据非常合适，通信线路的利用率得到大大提高**

为了提高分组交换的可靠性，因特网的核心部分常采用网状拓扑结构，路由器可以灵活地改变转发路由，避免发生通信中断或全网的瘫痪

**分组交换的优点：**

![](D:\office\word\计算机基础\计算机网络\截图\分组交换的优点.jpg)

**分组交换的问题：**

- 分组在各路由器存储转发时需要排队，会造成一定的**时延**
- 无法确保通信时端到端所需的带宽
- 各分组携带的控制信息会造成一定的开销（overhead），整个分组交换网需要专门的管理和控制机制

#### 报文交换（message switching）

自古代就有的邮政通信其本质也属于存储转发方式

**电报通信也采用了基于存储转发原理的报文交换**，由于需要人工操作，报文交换的时延很长

#### 三种交换方式的主要特点

- 电路交换：整个报文的比特流连续地从源点直达终点，类似在管道中传送

- 报文交换：整个报文先传送到相邻结点，全部存储下来之后查找转发表，转发到下一个结点

- 分组交换：单个分组传送到相邻结点，存储之后查找转发表，转发到下个结点

### 3、计算机网络在我国的发展

1980年铁道部最早着手建设专用计算机广域网，1989年第一个公用分组交换网CNPAC建成

1994年我国用64kb/s专线正式连入因特网。目前可以和因特网互连的规模最大的全国范围的公用计算机网络是中国电信的CHINANET

中国教育和科研计算机网**CERNET**(China Education and Research NETwork，即中国教育网)是全国性学术计算机互联网络

### 4、计算机网络的类别

关于计算机网络的最简单定义是：一些互相连接的、自治的计算机的集合（自治即独立的计算机）

#### 按网络的作用范围进行分类

##### **广域网WAN(wide area network)**

作用范围通常为几十到几千公里，**也叫作远程网**

广域网是因特网的核心部分，其任务是通过长距离运送主机所发送的数据。连接广域网各结点交换机的链路一般都是高速链路

##### **城域网MAN（metropolitan area network）**

作用范围一般是一个城市，可以是几个街区或整个城市，可以是单位所有或是公用设施，将多个局域网互连。

城域网一般采用以太网技术，因此有时会将其纳入局域网的范围进行讨论

##### **局域网LAN（local area network）**

一般用微型计算机或工作站通过高速通信线路相连（速率通常在10Mb/s以上），地理上则局限在很小的范围

现在局域网使用广泛，一个学校或企业拥有许多个互连的局域网，**即校园网或企业网**

**个人区域网PAN（personal area network）**

在个人工作的地方把属于个人使用的电子设备用无线技术连接起来的网络，**也叫作无线个人区域网WPAN（wireless PAN）**

**注：若中央处理机之间的距离非常近（1米或更小），则一般叫做多处理机系统而不叫做计算机网络**

#### 按网络的使用者进行分类

**公用网（public network）**

是指电信公司出资建造的大型网络，也叫作公众网

**专用网（private network）**

某个行业、部门为各自的特殊业务工作需要而建造的网络，不对外人提供服务

**接入网AN（access network）**

把用户接入到因特网的网络，**也叫作本地接入网或居民接入网**

接入网是由端系统到第一个路由器之间的一些物理链路组成。很多接入网属于局域网，它是用户和因特网连接的桥梁

### 5、计算机网络的性能

#### 1、速率

连接在计算机网络上的主机在数字信道上**传送数据的速率**，单位是b/s（bit/s，bps）

计算机发送出的信号都是数字形式的，**比特是计算机中数据量的单位，也是信息论中使用的信息量的单位**

**这里的k，M，G，T的量级是10^3**

#### 2、带宽（bandwidth）

频域称谓：

带宽本来是指某个信号具有的**频带宽度，是信号所包含的各种不同频率成分所占据的频率范围**。表示通信线路允许通过的信号频带范围就称为线路的带宽，单位是赫（Hz）

时域称谓：

**在计网中，带宽用来表示网络的通信线路传送数据的能力，网络带宽即表示在单位时间内从网络中的某一点到另一点所能通过的最高数据率，单位是比特每秒，b/s**

#### 3、吞吐量（throughput）

单位时间内通过某个网络的数据量，它受到带宽或速率的限制。比如100Mb/s的以太网，这就是吞吐量的上限

#### 4、时延（delay或latency）

数据从网络（或链路）的一端传送到另一端所需的时间，**也叫作延迟或迟延**

发送时延：数据帧长度（b）/发送速率（b/s）

传播时延：信道长度（m）/电磁波在信道上的传播速率（m/s）

总时延=发送时延+传播时延+处理时延+排队时延

**注：对于高速网络链路，我们提高的仅仅是数据的发送速率而不是比特在链路上的传播速率，荷载信息的电磁波在通信线路上的传播速率（光速的数量级）和数据的发送速录无关**

**提高数据的发送速率只是减小了数据的发送延迟**

发送速率单位是b/s，传播速率单位是km/s，因此一般说的光纤信道的传输速率高**其实是指发送速率高**

#### 5、时延带宽积

![](D:\office\word\计算机基础\计算机网络\截图\时延带宽积.jpg)

时延带宽积=传播时延 x 带宽

也叫作**以比特为单位的链路长度**

**只有代表链路的管道都充满比特时，链路才得到充分利用**

#### 6、往返时间RTT（Round Trip Time）

表示从发送方发送数据开始，到其收到来自接收方的确认（接收方收到数据后立即发送确认）总共经历的时间

发送的数据块越长，往返时间越多

#### 7、利用率

**信道利用率指某信道有百分之几的时间是被利用的（有数据通过）**

网络利用率则是**全网络的信道利用率的加权平均值**

**注：信道利用率并非越高越好，当它增大时，该信道引起的时延也就迅速增加。信道或网络利用率过高会产生非常大的时延**

![](D:\office\word\计算机基础\计算机网络\截图\利用率公式.jpg)

D0表示网络空闲时的时延

D表示当前时延

U代表网络利用率（0<U<1），当U达到其容量的1/2时，时延就要加倍。U接近最大值1时，时延趋于无穷大

![](D:\office\word\计算机基础\计算机网络\截图\利用率图.jpg)

一般ISP控制他们的信道利用率不超过50%，若超过了就需要准备扩容，增大线路的带宽

### 6、计算机网络体系结构

在计网中分层次的体系结构是最基本的，分层可将庞大复杂的问题转化为若干较小的局部问题，易于研究和处理

国际标准化组织ISO提出一个使计算机在世界范围内互连成网的标准框架——**开放系统互连基本参考模型**  OSI/RM（Open Systems Interconnection Reference Model），简称OSI。OSI是抽象的概念，仅仅考虑系统中与互连有关的部分

1983年形成了开放系统互连基本参考模型的正式文件，即ISO 7498国际标准，也就是七层协议的体系结构

OSI只获得理论研究的成果，市场化失败，因特网并未使用OSI标准

**得到最广泛应用的是TCP/IP，它成为事实上的国际标准**

计算机网络中要有条不紊地交换数据，就必须遵守事先约定好的规则，**规则明确了所交换的数据的格式和有关的同步问题（同步是一定条件下应该发生什么事件）**，因此同步含有时序的意思

**为进行网络中的数据交换而建立的规则、标准或约定称为网络协议（network protocol），简称协议**，它是计网不可或缺的组成部分

**协议的结构应该是层次式的**

**协议**由三要素组成：

- 语法：数据与控制信息的结构或格式
- 语义：需要发出何种控制信息，完成何种动作以及做出何种响应
- 同步：事件实现顺序的详细说明

我们在自己的PC机上进行文件的读取或存盘就不需要任何网络协议

**协议**的两种形式：

- 便于人类阅读和理解的文字描述
- 让计算机能够理解的程序代码

**计算机网络的各层及其协议的集合称为网络的体系结构，也就是计算机网络及其构件所应完成的功能的精确定义。如何利用软硬件完成这些功能则是遵循这种体系结构的实现**

体系结构是抽象的，而实现是具体的，它是真正运行的计算机软硬件

#### 具有五层协议的体系结构

TCP/IP体系结构应用广泛，它是一个四层的体系结构：应用层、运输层、网际层（解决不同网络的互连问题）、网络接口层。

TCP/IP从实质上来说，它只有最上面的三层，最下面一层和一般的通信链路在功能上类似，对计网来说这层没什么特别新的具体内容

**我们会综合OSI和TCP/IP的优点，采用一种只有五层协议的体系结构**

![](D:\office\word\计算机基础\计算机网络\截图\五层协议.jpg)

- **应用层（application layer）**通过应用进程间的交互来完成特定网络应用，这层的协议定义了应用进程间通信和交互的规则，包括HTTP、SMTP、FTP协议等。**应用层交互的数据单元叫作报文（message）**

- **运输层（transport layer）** 负责向两个主机中进程之间的通信提供通用的数据传输服务，多个应用可以使用同一运输层服务。运输层有**复用和分用**的功能，复用即多个进程同时使用运输层服务；分用是把收到的信息分别交付到应用层中的相应进程

  ​			运输层包括**传输控制协议TCP（Transmission Control Protocol）**，提供面向连接的、可靠的数据传输服务，它的数据传输单位是**报文段（segment）**

  ​			**用户数据报协议UDP（User Datagram Protocol）**，提供无连接的、尽最大努力的数据传输服务，不保证数据传输的可靠性，数据传输单位是**用户数据报**

- **网络层（network layer）**负责为分组交换网上的不同主机提供通信服务。发送数据时，网络层把运输层产生的报文段或用户数据报**封装成分组或包（packet）进行传送**。在TCP/IP体系中，网络层使用IP协议，**分组也叫作IP数据报或数据报。**

  网络层的另一任务就是选择合适的路由，使分组能够通过路由器找到目的主机。网络层的网络不是具体的网络。因特网主要的网络层协议是**网际协议IP（Internet Protocol）**，还包括许多路由选择协议，**也叫作网际层或IP层**

- **数据链路层（data link layer）简称链路层**，两台主机之间的数据传输总要在一段一段的链路上进行传送。两个相邻结点传送数据时，链路层会将网络层交下来的IP数据报**组装成帧（frame）**，在相邻两个结点间的链路上传送帧。**每一帧包括数据和必要的控制信息**，接收数据时可以提取其中的数据交给网络层。控制信息还能检测错误帧并将它丢弃。如果需要改正数据在链路层出现的差错，就要采用可靠的传输协议

- **物理层（physical layer）**传送的数据单位是比特，物理层需要考虑多大的电压表示1或0,以及接收方如何识别发送方所发送的比特。一些物理媒体比如光缆、无线信道等不在物理层协议之内，也有人将这些物理媒体当做第0层

**注：无论哪一层传送的数据单元，都可以笼统地用分组来表示**

TCP/IP并不是单指这两个具体协议，而是整个TCP/IP协议族

![](D:\office\word\计算机基础\计算机网络\截图\数据在各层的传递过程.jpg)

H和T表示首部和尾部的控制信息；AP表示应用进程

传送比特流时应该从首部开始传送

OSI将**对等层次之间传送的数据单位**称作该层的**协议数据单元PDU（Protocol Data Unit）**

各层协议实际上就是在各个对等层之间传递数据时的各项规定

#### 实体、协议、服务和服务访问点

**实体（entity）**表示任何可发送或接受信息的硬件或软件进程。

**协议**是控制两个对等实体（或多个实体）进行通信的规则的集合，两个对等实体间的通信使本层能够向上一层提供服务，当然本层也需要使用下面一层所提供的服务

使用本层服务的实体只能看见服务而无法看见下面的协议，即下面的协议对上面的实体是透明的

协议是水平的，控制对等实体

服务是垂直的，由下层向上层通过层间接口提供，只有能被上层实体“看得见”的功能才叫做服务，并不是一层内完成的全部功能。**上层使用下层所提供的服务必须通过与下层交换一些命令，这些命令在OSI中叫作服务原语**

**服务访问点SAP(Service Access Point)**是在同一系统中相邻两层的实体进行交互（交换信息）的地方，它是抽象的概念

OSI将层与层之间交换的数据的单位叫作**服务数据单元SDU（Service Data Unit）**。可以是多个SDU合成一个PDU，也可以是一个SDU划分为几个PDU

![](D:\office\word\计算机基础\计算机网络\截图\相邻两层之间的关系.jpg)

第n层向上面的n+1层所提供的服务实际上包含了在它以下各层所提供的服务

**协议必须将所有不利的条件事先估计到，不能假定一切都是正常的和理想的**

#### TCP/IP的体系结构

TCP/IP的体系结构只有四层

![](D:\office\word\计算机基础\计算机网络\截图\四层的体系结构.jpg)

**路由器在转发分组时最高只用到网络层**

**技术的发展并不是严格遵循OSI的分层概念，现在的TCP/IP体系结构有时已经演变了，引用程序可以直接使用IP层，或最下面的网络接口层（子网层）。**

![](D:\office\word\计算机基础\计算机网络\截图\含具体协议的四层体系.jpg)

两头大中间小：应用层和网络接口层都有很多种协议。TCP/IP协议可以为各式各样的应用提供服务（everything over IP）,同时它也允许IP协议在各式各样的网络构成的互联网上运行（IP over everything）

## 二、物理层

### 1、基本概念

物理层**考虑的是怎样才能在连接各种计算机的传输媒体上传输数据比特流**，而不是指具体的传输媒体。**它的作用是要尽可能屏蔽传输媒体和通信手段的差异，使得数据链路层感觉不到这些差异**

物理层的协议叫作**物理层规程（procedure）**

物理层的主要任务是**确定与传输媒体的接口有关的一些特性**：

- **机械特性** 	指明接口所用接线器的形状和尺寸、引脚数目和排列等等
- **电气特性**     指明接口电缆的各条线上出现的电压范围
- **功能特性**     指明某条线上出现的某一电平的电压表示何种意义
- **过程特性**     指明对于不同功能的各种可能事件的出现顺序

数据在计算机中多采用并行传输，但在通信线路（传输媒体）一般是串行传输，**因此物理层还需要完成传输方式的转换**

由于物理连接方式很多（点对点、多点连接或广播连接），传输媒体种类也很多（架空明线、双绞线、电缆、光缆、无线信道等），因此物理层协议种类很多，只需掌握基本概念

### 2、数据通信的基础知识

#### 数据通信系统的模型

一个数据通信系统可划分为三大部分：**源系统（发送端、发送方）、传输系统（传输网络）、目的系统（接收端、接收方）**

![](D:\office\word\计算机基础\计算机网络\截图\数据通信系统.jpg)

**源系统**

- **源点（source）**: 也叫作**源站、信源**。源点设备产生要传输的数据，比如PC产生输出的数字比特流
- **发送器**：源点生成的数字比特流要通过发送器编码后才能够在传输系统中传输，**典型的发送器就是调制器**，现在很多PC内置调制解调器（包含调制器和解调器）

**目的系统**

- **接收器**：接收传输系统传送过来的信号，并转换为能够被目的设备处理的信息，**典型的接收器就是解调器**，将传输线路上的模拟信号进行解调，提取消息并还原出发送端产生的数字比特流

- **终点**：从接收器获取传送来的数字比特流，然后将信息输出

**传输系统可以是简单的传输线，也可以是连接在源系统和目的系统之间的复杂网络系统**

**常用术语**

通信的目的是传送**消息（message）**，语音、文字、图片、视频等都是消息。**数据**是运送消息的实体

**信号则是数据的电气或电磁表现**

**信号分类：**

- **模拟信号（连续信号）** 代表消息的参数取值是连续的
- **数字信号（离散信号）**代表消息的参数取值是离散的，在使用时间域（时域）的波形表示数字信号时，代表不同离散数值的基本波形叫作**码元**，二进制编码中一种叫作0，一种叫作1

#### 信道的概念

**信道一般指用来表示某一个方向传送信息的媒体**，一条通信电路往往包含一条发送和一条接收信道

**从通信双方信息交互的方式看，有三种形式：**

- **单向通信（单工通信）**只能有一个方向的通信而没有反方向的交互，比如无线电广播或有线电广播或电视广播
- **双向交替通信（半双工通信）**通信双方都可以发送信息，**但不能同时发送（也不能同时接收）**。可以一方发送另一方接收，一段时间后再反过来
- **双向同时通信（全双工通信）** **通信双方可以同时发送和接收信息**

来自信源的信号常叫作**基带信号（即基本频带信号）**。计算机输出的各种文字或图像文件的数据信号都是基带信号。基带信号它往往有较多的低频成分或直流成分，**信道不能传输这种低频或直频分量，因此必须对基带信号进行调制**

**调制分为两类：**

- 仅仅对基带的波形进行变换，使他能够和信道特性相适应。变换后仍为基带信号，这种叫作**基带调制**。它将数字信号转换为另一种形式的数字信号，因此也叫作**编码**
- 使用**载波（carrier）**进行调制，将基带信号的频率范围搬移到较高的频段，转换为模拟信号。经过载波调制后的信号叫作**带通信号（仅在一段频率范围内能够通过信道）**，载波调制也叫作**带通调制**

#### 信道的极限容量

通信领域的学者一直在寻找提高数据传输速率的途径，任何实际的信道都不是理想的，传输信号是会产生各种失真

**数字通信的优点是只要接收端能从失真的波形识别出原来的信号，那么这种失真对通信质量就无影响**

码元传输的速率越高、信号传输的距离越远、噪声干扰越大、传输媒体质量越差，这些都会使接收端的波形失真越严重，导致无法识别

**限制码元在信道上传输速率的因素：**

- **信道能通过的频率范围**  具体的信道所能通过的频率范围总是有限的，信号中许多高频分量往往不能通过信道。**奈氏准则**指出，任何信道中码元的传输速率是有上限的，若超过它，就会出现严重的码间串扰问题，使得接收端的识别变得不可能。

​       **因此信道的频带越宽，也就是能通过的信号高频分量越多，那么就可以用更高的速率传送码元而不出现码间串扰**

- **信噪比**  噪声存在于所有的电子设备和通信信道中，它是随机产生的。**噪声会使接收端对码元的判决产生错误（1变为0，0变为1）。**

  但是噪声的影响是相对的，**信号相对越强，噪声的影响就小。信噪比就是信号的平均功率和噪声的平均功率之比，记为S/N，用分贝（dB）作为度量单位**

  信息论的创始人香农推导出**香农公式**。**它表明信道的带宽或信道的信噪比越大，信息的极限传输速率就越高。**它指出了信息传输速率的上限，因此只要信息传输速率低于信道的极限信息传输速率，就一定可以找到某办法来实现无差错传输

  **若信道的频带宽度确定，信噪比也无法提高，码元传输速率达到上限，还可以用编码的方法让每一个码元携带更多比特的信息量来提高信息的传输速率**

### 3、物理层下面的传输媒体

**传输媒体也叫作传输介质或传输媒介**，它是数据传输系统中在发送器和接收器之间的物理通路

传输媒体分为两类：导引型和非导引型。

导引型中电磁波被导引沿着固体（铜线或光纤）媒体传播

非导引型就是自由空间，常称为无线传输

### 4、信道复用技术

#### 频分、时分、统计时分复用

如果大家分别使用一个单独信道通信，复用简单说就是让大家合起来使用一个共享信道进行通信

最基本的复用就是**频分复用FDM（frequency division multiplexing）和时分复用TDM（time division multiplexing）**

**频分复用的所有用户在同样的时间占用不同的带宽（这是频率带宽）资源**，用户分配到一定频带后，在通信时从始至终都占用这个频带

**时分复用的所有用户是在不同的时间占用同样的频带宽度**，将时间划分为一段段等长的**时分复用帧（TDM帧）**。每一个用户在每个TDM帧中占用固定序号的**时隙**，每个用户的时隙周期性出现（周期就是TDM帧的长度），因此TDM信号也称为**等时信号**

时分复用更有利于数字信号的传输

![](D:\office\word\计算机基础\计算机网络\截图\时分、频分复用.jpg)

通信时**复用器和分用器**成对使用，它们之间是用户共享的高速信道

**由于计算机数据的突发性，使用时分复用系统时，一个用户对已经分配到的子信道利用率一般不高，造成线路资源的浪费**

**统计时分复用STDM（statistic TDM）**是改进的时分复用，它能明显提高信道的利用率。**集中器**常使用这种统计时分复用

![](D:\office\word\计算机基础\计算机网络\截图\统计时分复用.jpg)

如图，集中器连接4个低速用户，将它们的数据集中起来通过高速线路发送到一个远地计算机

它使用STDM帧传送复用数据，但每个帧中的时隙数小于连接在集中器上的用户数

用户有了数据随时发往集中器的输入缓存，集中器按顺序依次扫描输入缓存之后放入STDM帧，没有数据的缓存就跳过，帧满则发送。**STDM帧不是固定分配时隙，它是按需动态分配，因此统计时分复用可以提高线路的利用率**

某用户所占的时隙不是周期出现的，以不可预知的方式来占用，因此**统计复用时分也叫作异步时分复用，普通的时分复用则是同步时分复用（有占用顺序）**

集中器能正常工作的前提是假定各用户都是间歇工作，从平均角度看，统计时分复用的输出线路上的数据率和个输入线路数据率的和是平衡的

由于动态分配，每个时隙还需有用户的地址信息，这是统计时分复用必须有且不可避免的开销

**注：这里的帧都是物理层传送的比特流中所划分的帧，和以后数据链路层的帧是不同概念，不能混淆**

#### 波分复用

波分复用WDM（wavelength division multiplexing）就是光的频分复用

### 5、宽带接入技术

因特网发展初期用户利用电话的用户线通过调制解调器连接到ISP，速率最高只有56kb/s

宽带可以分为有限宽带接入和无线宽带接入。这里讨论有限宽带接入

ADSL技术：非对称数字用户线，用数字技术对现有的模拟电话用户线进行改造

HFC网：光纤同轴混合网，在有限电视网的基础上开发的居民宽带接入网

FTTx技术：光纤到户

## 三、数据链路层

数据链路层属于计算机网络的低层，它使用的信道主要是两种类型：

- **点对点通信** 这种信道使用一对一的点对点通信方式
- **广播通信**  这种信道使用一对多的广播通信方式，过程复杂，广播信道上连接的主机很多，因此必须使用专用的共享信道协议来协调这些主机的数据发送

网络层要讨论的问题是分组怎样从一个网络通过路由器转发到另一个网络。**但是本章我们研究的是在同一个局域网中，分组怎样从一个主机传送到另一个主机，这是属于数据链路层的范围**

![](D:\office\word\计算机基础\计算机网络\截图\从层次上看数据的流动.jpg)

![](D:\office\word\计算机基础\计算机网络\截图\只考虑链路层.jpg)

在专门研究数据链路层的问题时，一般我们只关心在协议栈中水平方向的各数据链路层

两个主机间的通信可以看成四段不同的链路层通信组成，这四段不同的链路层可能采用不同的数据链路层协议

### 1、使用点对点信道的数据链路层

点对点信道的数据链路层中某些概念对广播信道也适用

#### 数据链路和帧

**链路就是从一个结点到相邻结点的一段物理线路（有线或无线），中间没有任何其他的交换结点。**在数据通信时两个计算机间的通信路径会经过许多段这样的链路

数据链路是另一个概念。在一条线路上传送数据时，除了一条物理线路，还必须有一些必要的通信协议来控制这些数据的传输。**把实现协议的硬件和软件加到链路上，这就构成了数据链路**。最常用的方法是使用**网络适配器（包括软硬件）**来实现协议，一般适配器包括数据链路层和物理层这两层的功能

**也有另一种说法，物理链路即上面的链路，逻辑链路就是上面的数据链路，是物理链路加上必要的通信协议**

![](D:\office\word\计算机基础\计算机网络\截图\数据链路层简化的三层模型.jpg)

数据链路层把网络层交下来的数据构成**帧**发送到链路上，以及将接收到的帧中的数据取出并上交网络层

**点对点信道的数据链路层通信时的步骤：**

- 结点A的数据链路层把网络层交下来的IP数据报添加首部和尾部封装成**帧**
- 结点A将封装好的帧发送给结点B的数据链路层
- 若结点B的数据链路层收到的帧无差错，则从其中提取IP数据报交到上面的网络层，否则丢弃这个帧

#### 三个基本问题

三个基本问题是**封装成帧、透明传输、差错检测**

##### 封装成帧

![](D:\office\word\计算机基础\计算机网络\截图\封装成帧.jpg)

**封装成帧（framing）**即在一段数据前后分别添加**首部和尾部**，这就构成了一个帧。**帧是数据链路层的数据传送单元**

接收端收到物理层上交的比特流后，可以根据首部和尾部的标记从收到的比特流中**识别帧的开始和结束，首部和尾部的一个重要作用就是帧定界（确定帧的界限）**

分组交换的一个重要概念就是所有在因特网上传送的数据都是以分组（即IP数据报）为传送单位的，**网络层的IP数据报传送到数据链路层就成为帧的数据部分** 

首部和尾部还包括许多必要的控制信息，发送帧时是从首部开始发送。

各个数据链路层协议都对帧首尾部的格式有明确规定，为了提升帧的传输效率，应使帧的数据部分长度尽肯能大于首尾部的长度。但每种链路层协议都规定了所能传送的帧的**数据部分长度上限——最大传送单元MTU（maximum transfer unit）**

当数据是可打印的ASCII码组成的文本文件时，帧定界可使用特殊的**帧定界符**，**控制字符SOH（start of header）和EOT（end of transmission）**分别表示帧的开始和结束。

当数据传输出错时，帧定界符作用更明显。假定发送端尚未发送完一个帧时突发故障，中断了传送。但随后很快恢复，重新从头开始发送。这时候由于使用了帧定界符，接收端就知道前面的数据是不完整的帧，必须丢弃



##### 透明传输

**透明**表示**某一个实际存在的事物看起来好像不存在一样**

在传输的数据中，不能出现和用作帧定界的控制字符相同的比特编码，否则会出现帧定界的错误

使用文本文件（字符都是从键盘输入的）传输数据时，数据部分显然不会出现SOH和EOT这样的控制字符。因此这样的传输是**透明传输**，这些数据看不见链路层有什么妨碍它们传输的东西，即数据链路层对数据来说是透明的

但数据部分是非ASCII码的文本文件时，若数据中某个字节的二进制代码正好和SOH或EOT相同，则会错误地找到帧边界。这就不是透明传输，因为当数据中遇到“EOT”时就传不过去了。

这时需要将发送端的数据链路层**在数据中出现控制字符的前面插入一个转义字符“ESC”，接收端将数据送往网络层之前删除它**。这是**字节填充或字符填充**。若数据中原本就有转义字符，那就在它前面再插入一个转义字符



##### 差错检测

现实的通信链路都不会是理想的，比特在传输过程中可能产生差错：1变为0，0变为1。这就是**比特差错**。这里的差错一般就是比特差错，除非特殊说明

在一段时间内， **传输错误的比特占传输比特总数的比率**叫作**误码率BER（bit error rate）**，**它与信噪比有很大的关系，若信噪比越高，误码率就越小**。比如误码率为10^-10次方时，表示平均每传送10^10个比特就会出现一个比特的差错

实际上误码率不可能降为0，因此为了保证数据传输的可靠性，在计算机网络传输数据时必须采用各种差错检测措施。目前数据链路层广泛使用了**循环冗余检测CRC（cyclic redundancy check）**的检错技术

**CRC原理：**

发送端先把数据划分为组，假定每组k个比特。假定待传送的数据M=101001（k=6），CRC运算就是在M后面添加供差错检测用的**n位冗余码**，构成一个帧发出去，总共发送k+n位。冗余码叫作**帧检测序列FCS（frame check sequence）**

虽然这增大数据传输的开销，但当传输可能出现差错时，这种代价值得

**计算生成FCS的方法：**

使用2^n乘M，这相当于在M后添加n个0（类比十进制中乘10^n），得到k+n位

再用这个数除以**收发双方约定好的长度为n+1位的除数P**，得出商是Q而余数是R（n位）。**余数R就作为FCS，和数据M进行拼接发送**

**接收端的CRC检验**：

在接收端将接收的数据以帧为单位进行CRC检验，即每一帧都除以同样的除数P，检查得到的余数R。**若传输无差错，则余数R肯定是0，就可以判定此帧无差错。若非0，则判定有差错，就丢弃**

数据链路层中发送端帧检测序列FCS的生成和接收端的CRC检验都是**硬件完成**，处理很迅速，不会延误数据传输

**在数据链路层若仅仅使用CRC差错检测技术，则只能做到对帧的无差错接受，即凡是接收端数据链路层接受的帧，都能以非常接近于1的概率认为这些帧传输时没产生差错。**

**上述语句可以近似表述为（通常都是这样认为）凡是接收端数据链路层接受的帧均无差错**

**注意：**

现在我们并没有要求数据链路层向网络层提供可靠传输的服务。**可靠传输就是数据链路层的发送端发送什么，在接收端就收到什么**

**传输差错分为两类：**

- 一类是之前说的最基本的比特差错
- 另一类传输差错更复杂，收到的帧没有出现比特差错，但出现了**帧丢失、帧重复或帧失序（后发送的帧反而先到达接收端）**

**在数据链路层使用CRC检验能够实现无比特差错的传输，但这还不是可靠传输**

过去OSI的观点是**必须让数据链路层向上提供可靠传输**，因此在CRC基础上**增加了帧编号、确认和重传机制**。收到正确的帧需向发送端发送确认，若发送端一定期限内未收到对方的确认，就认为出现差错从而进行重传，直到收到对方的确认为止

但现在的通信线路质量大大提高，由于通信链路质量差引起的差错概率也大大降低，因此**因特网采取区别对待的方式：**

- 对于通信质量良好的有线传输链路，数据链路层协议不使用确认和重传机制，**即不要求数据链路层向上提供可靠传输的服务**，若数据链路层传输数据时出现差错并需要改正，此任务由上层协议来完成
- 对于通信质量较差的无线传输链路，数据链路层协议使用确认和重传机制，它需要向上层提供可靠传输的服务

实践表明这样做可以提高通信效率

### 2、点对点协议PPP

在通信线路质量较差的年代，在数据链路层使用可靠传输协议曾经是一种好办法。因此**能实现可靠传输**的**高级数据链路控制HDLC（high-level data link control）**就成为当时比较流行的数据链路层协议

但现在的HDLC很少使用，对于点对点的链路，更加简单的**点对点协议PPP（point-to-point protocol）**则是目前使用最广泛的数据链路层协议

#### PPP协议的特点

PPP协议**就是用户计算机和ISP进行通信时所使用的的数据链路层协议**

![](D:\office\word\计算机基础\计算机网络\截图\PPP协议.jpg)

PPP协议在1992年由IETF制定，在1994年成为因特网的正式标准[RFC1661]

**PPP协议应满足的需求：**

- **简单**  IETF在设计因特网体系结构时将最复杂的部分放在TCP协议中，而IP协议相对简单，它提供的是不可靠的数据报服务。因此数据链路层没必要提供比IP协议更多的功能。

  因此对于数据链路层的帧不需要纠错、序号和流量控制，**简单**是首要需求。简单的设计使协议在实现时不容易出错，不同厂商在协议的不同实现上其**互操作性提高了**。

  总之，这种数据链路层的协议非常简单，接收方每收到一个帧，就进行CRC检验，若检验正确则收下这个帧，否则丢弃。**其他什么也不做**

- **封装成帧**  PPP协议必须规定特殊的字符作为**帧定界符**，以便接收端从收到的比特流中能准确找出帧的开始和结束位置

- **透明性**  PPP协议必须保证数据传输的透明性

- **多种网络层协议**  PPP协议必须能在**同一条物理链路上同时支持多种网络层协议的运行**，当点对点链路连接的是局域网或路由器时，PPP协议必须同时支持在这个局域网或路由器上运行的各种网络层协议

- **多种类型链路**  PPP协议必须能在多种类型的链路上运行，比如串行或并行、同步或异步、电或光、交换（动态的）或非交换（静态的）的点对点链路。

  PPPoE是在以太网上运行的PPP（PPP over Ether-net），它是PPP协议能够适应多种类型链路的一个典型例子。它是为宽带上网的主机使用的链路层协议，将PPP帧再封装到以太网帧中

- **差错检测**  PPP协议必须能对接收端收到的帧进行检测，并立即丢弃有差错的帧。若不丢弃的话这些无用帧还会在网络中继续向前转发，白白浪费网络资源

- **检测连接状态**  PPP协议必须具有一种机制能及时（不超过几分钟）自动检测出链路是否处于正常工作状态

- **最大传送单元**  PPP协议必须对每种类型的点对点链路设置**最大传送单元MTU**的标准默认值，可提高各种实现之间的互操作性。若高层协议发送的分组超过MTU的数值，则丢弃这样的帧并返回差错。**MTU是数据链路层的帧可以载荷的数据部分的长度，不是帧的总长度**

- **网络层地址协商**  PPP协议必须提供一种机制**使通信的两个网络层实体能够通过协商知道或能配置彼此的网络层地址**。此协商的算法需要尽可能简单且一定得出协商结果。

  这对拨号连接的链路很重要，仅仅在链路层建立了连接而不知道对方的网络层地址时，不能保证网络层可以传送分组

- **数据压缩协商**  PPP协议必须提供一种方法来协商使用数据压缩算法，但它不要求将数据压缩算法标准化

**PPP协议只支持点对点的链路通信，只支持全双工链路，不支持多点线路（一个主站轮流和链路上的多个从站进行通信）**

**PPP协议的组成：**

PPP协议有三部分组成

- 一个将IP数据报封装到串行链路的方法，PPP既支持异步链路（无奇偶检验的8bit数据），也支持面向比特的同步链路
- 一个用来建立、配置和测试数据链路连接的**链路控制协议LCP（link control protocol）**
- 一套**网络控制协议NCP（network control protocol）**

#### PPP协议的帧格式

![](D:\office\word\计算机基础\计算机网络\截图\PPP协议的帧格式.jpg)

**各字段的意义**

标志字段F（flag）规定为0x7E，即16进制下的7E，**标志字段表示一个帧的开始或结束**。

**在连续两帧之间只需要用一个标志字段（即连续两帧之间共用一个标志字段），若连续出现两个标志字段，则代表是空帧，应当丢弃**

首部中的地址字段A规定为0xFF，控制字段C规定为0x03，它们实际上没有携带PPP帧的信息

首部第四个字段是2字节的**协议字段**，当协议字段是0x0021时，信息字段就是IP数据报；若为0xC021，则信息字段是PPP链路控制协议LCP的数据；0x8021表示这是网络层的控制数据

**字节填充**

信息字段出现和标志字段一样的比特组合（0x7E，即01111110）时，就必须使他们不出现在信息字段中

PPP使用**异步传输（逐个字符地传送）**时将转义符定义为0x7D，使用**字节填充**，将需要转义的一个字节转变为2个字节

发送端进行字节填充，接收端收到数据再进行相反的变换得到正确信息

**零比特填充**

**同步传输（一连串的比特连续传送）**时采用零比特填充法来实现透明传输

发送端扫描整个信息字段，**只要出现5个连续的1，则在其后立即填入0**，保证不会出现6个连续1（标志字段就是6个连续的1）。接收端再将它删除从而还原之前的信息比特流

#### PPP协议的工作状态

当用户拨号接入ISP后，就建立了一条从用户到ISP的物理连接。

这时用户PC向ISP发送一系列的链路控制协议LCP分组（封装成多个PPP帧），以便建立LCP连接，这些分组及其响应选择了将要使用的一些PPP参数

接着进行网络层配置，网络控制协议NCP给新接入的用户PC分配一个临时的IP地址，这样用户PC就成为因特网上的一个有IP地址的主机

用户通信完毕，NCP释放网络层连接，收回原来分配出去的IP地址。接着LCP释放数据链路层连接，最后释放物理层的连接

![](D:\office\word\计算机基础\计算机网络\截图\PPP工作过程.jpg)

PPP链路的起始和终止状态永远是图中的链路静止（link dead）状态，这时用户PC和ISP的路由器之间不存在物理层的连接

用户PC通过调制解调器呼叫路由器，此时路由器能检测到调制解调器发出的载波信号。双方建立了物理层连接后，PPP就进入了链路建立状态，它的目的是建立链路层的LCP连接。此时LCP开始配置协商，配置选项包括最大帧长、使用的**鉴别协议**、不使用PPP帧中的地址和控制字段（它们值固定，可以在PPP帧的首部省略这两个字节）

协商结束双方就建立了LCP链路，接着进入鉴别状态。这一状态只允许传送LCP协议的分组、鉴别协议分组和检测链路质量的分组。**口令鉴别协议PAP（password authentication protocol）**需发起通信的一方发送身份标识符和口令。若需要更好的安全性则可使用更复杂的**CHAP口令握手鉴别协议**。鉴别身份失败则转到链路终止，成功则进入网络层协议状态

在网络层协议状态，NCP根据网络层不同协议互相交换网络层特定的网络控制分组，网络层可运行不同的网络层协议，仍然可以使用同一个PPP协议。如使用IP协议，则对PPP链路每一端配置IP协议模块时（如分配IP地址）就需使用NCP中支持IP的协议——**IP控制协议IPCP**

网络层配置完毕，链路进入可进行数据通信的链路打开状态，链路的两个PPP端点还能发送回送请求LCP分组和回送回答LCP分组，以检查链路的状态

数据传输结束后可由链路的一端发出终止请求LCP分组，收到对方的终止确认LCP分组后，转到链路终止。若链路出现故障，也会从链路打开转到链路终止状态。当调制解调器的载波停止后，则回到链路静止

**PPP协议不是纯粹的数据链路层协议，它还包含了物理层和网络层的内容**

### 3、使用广播信道的数据链路层

广播信道可以进行一对多通信

**局域网使用的就是广播信道**，局域网是在20世纪70年代发展起来的，在计算机网络中占有非常重要的地位

#### 局域网的数据链路层

局域网最主要的特点是**网络为一个单位所拥有，且地理范围和站点数目均有限**

**局域网优点：**

- 具有广播功能，从一个站点可以很方便地访问全网，局域网上的主机可共享连接在局域网上的各种硬件和软件资源
- 便于系统的扩展和逐渐地演变，各设备的位置可灵活调整改变
- 提高系统的可靠性、可用性和生存性

局域网可按**网络拓扑进行分类**

![](D:\office\word\计算机基础\计算机网络\截图\局域网的拓扑.jpg)

总线两端的匹配电阻吸收在总线上传播的电磁波信号的能量，避免在总线上产生有害的电磁波反射，总线网以传统以太网（以太网是应用最普遍的局域网技术）最为著名，**以太网几乎成为了局域网的同义词，因此从本节开始都是讨论以太网技术**

局域网可使用多种传输媒体，双绞线最为便宜， 它是局域网的主流传输媒体。当数据率很高时，往往使用光纤作为传输媒体

局域网工作的层次跨越了数据链路层和物理层，但是它数据链路层的内容较为丰富

**共享信道**着重考虑的问题是如何使众多用户能合理而方便地共享通信媒体资源，**静态划分信道**（之前的频分、时分、波分复用等）只要分配到了信道就不会和其他用户发生冲突，但代价太高，不适用于局域网

**动态媒体接入控制**也叫作**多点接入（multiple access）**,它的特点是信道并非在用户通信时固定分配给用户。它可分为两类：

- **随机接入**  所有用户可随机发送信息，但若恰巧有两个或更多的用户在同一时刻发送信息，那么在共享媒体上就要产生**碰撞（发生冲突）**，这会使用户的发送都失败，因此必须有解决碰撞的网络协议
- **受控接入**  用户不能随机发送信息，必须服从一定控制。它目前在局域网中使用很少

以太网的数据率已经到了百兆比特甚至10G比特，因此通常用**传统以太网**代表最早流行的10Mbps速率的以太网

**传统以太网**

1、**以太网的两个标准**

以太网是美国施乐（Xerox）公司在1975年研制成功的，它以曾在历史上表示传播电磁波的**以太（Ether）**来命名

DIX Ethernet V2是世界上第一个局域网产品的规约，IEEE 802委员会802.3工作组在1983年制定了第一个IEEE的以太网标准，数据率为10Mbps。以太网的这两个标准只有很小的差别

为了使数据链路层能更好适应多种局域网标准，**IEEE 802委员会把局域网的数据链路层拆成两个子层，即逻辑链路控制LLC（logical link control）子层和媒体接入控制MAC（medium access control）子层**

与接入到传输媒体相关的内容放在MAC子层，而LLC子层与传输媒体无关，不管采用何种传输媒体和MAC子层的局域网对LLC子层都是透明的。

由于因特网中TCP/IP体系经常使用的局域网只剩下DIX Ethernet V2，因此由802委员会制定的LLC子层的作用消失，**很多厂商生产的适配器仅装有MAC协议了，这里就不再讨论LLC**

2、**适配器的作用**

计算机和外界局域网的连接是通过通信**适配器（adapter）**，它本来是主机箱内插入的一块网络接口板（笔记本中是PCMCIA卡——个人计算机存储器卡接口适配器），它也叫**网络接口卡（network interface card），简称网卡**。但现在主机板上都嵌入了这种适配器，不再使用单独的网卡了。

适配器上装有处理器和存储器（包括RAM和ROM），适配器和局域网之间的通信通过电缆或双绞线以串行传输进行，适配器和计算机之间的通信是通过主办上的I/O总线以并行方式传输。**适配器的一个重要功能就是进行数据串行传输和并行传输的转换**

由于网络上的数据率和计算机总线上的数据率不同，适配器必须装有对数据进行缓存的存储芯片。

适配器需要能够实现以太网协议

适配器接收和发送各种帧时不使用计算机的CPU，它收到有差错的帧时可以将其丢弃而不必通知计算机，适配器收到正确的帧时通过中断来通知计算机并交付协议栈中的网络层。当计算机要发送IP数据报时就由协议栈把IP数据报向下交给适配器，组装成帧后发送到局域网

**计算机的硬件地址在适配器的ROM中，而软件地址即IP地址则在计算机的存储器中**

![](D:\office\word\计算机基础\计算机网络\截图\适配器.jpg)



#### CSMA/CD协议

最早的以太网是将许多计算机都连接到一根总线上，总线的特点是当一台计算机发送数据时，总线上的所有计算机都能检测到这个数据，这就是广播通信方式

总线上同样可以实现一对一通信，可以使每一台计算机的适配器拥有一个和其他适配器不同的地址。发送数据帧时可以在帧的首部写明接收站的地址。只有数据帧中的目的地址和适配器中存放的硬件地址一致时其才能接收这个数据帧，否则就丢弃

局域网上的计算机叫作主机、工作站、站点或站

**以太网为了通信方便，采取两点措施：**

1、以太网采用较为灵活的**无连接**工作方式，不必建立连接即可发送数据，适配器对发送的数据帧不进行编号，也不要求对方发回确认。**因此以太网提供的服务是尽最大努力的交付，即不可靠交付。目的站收到有差错的数据帧时就丢弃，是否需要重传则由高层来决定**。以太网并不知道这是重传帧，而是当作新的数据帧来发送

总线上在同一时间只能允许一台计算机发送数据，即只要有一台计算机在发送数据，总线的传输资源就被占用。否则各个计算机之间就会互相干扰，使得所发送的数据被破坏

以太网采用最简单的随机接入，但是有很好的协议来**减少冲突发生的概率**，即**CSMA/CD（carrier sense multiple access with collision detection），载波监听多点接入/碰撞检测**

2、以太网发送的数据采用**曼彻斯特编码**的信号，一般二进制基带数字信号就是高、低电压交替出现的信号。但是当出现一长串的1或0时接收端就无法从收到的比特流中提取位同步（即比特同步，是指接收端时钟已经调整到和发送端时钟完全一样）信号。

曼彻斯特编码将每个码元再分成两个相等的间隔，保证每个码元在正中间出现一次电压的转换，方便接收端提取位同步信号。但是它所占的频带宽度比原始的基带信号增加了一倍（因为每秒传送的码元数加倍了）

![](D:\office\word\计算机基础\计算机网络\截图\曼彻斯特编码.jpg)

**CSMA/DA协议的要点**

- **多点接入**说明是总线型网络，许多计算机以多点接入的方式连接在一根总线上。**协议的实质是载波监听和碰撞检测**

- **载波监听**是使用电子技术检测总线上有无其他计算机也在发送。其实总线上没有载波，这里只是借用一下载波这个名词。载波监听就是**检测信道，不管在发送前还是发送中，每个站必须不停地检测信道**

  发送前检测是为了获得发送权，必须等信道变为空闲时才能发送。发送中检测信道是为了及时发现有没有其他站的发送和本站发送的碰撞，也就是碰撞检测

- **碰撞检测也就是边发送边监听**。当几个站同时在总线上发送数据时，总线上的信号电压变化幅度将会增大（互相叠加），它超过一定的门限值时，就认为总线上至少有两个站同时在发送数据，即发生了碰撞，也就是发生了冲突。**碰撞检测也叫作冲突检测**。

  一旦出现碰撞，总线上传输的信号就会严重失真，无法恢复出有用的信息，这时适配器需立即停止发送，避免浪费网络资源，等待一段随机时间后再次发送

电磁波在总线上是以有限速率传播的，它在1km电缆的传播时延约为5us。若A向B发送数据，B在A发送的数据到达B之前发送自己的帧（这时B的载波监听检测不到A所发送的信息），则必然发生碰撞

CSMA/CD协议中一个站**不可能同时进行发送和接收，但必须边发送边监听信道**，因此它是半双工通信（双向交替通信）。**单程端到端传播时延记为$\Gamma$，站点发送数据后最多经过2$\Gamma$（总线的端到端往返传播时延，总线两端的两个站点之间的传播时延为端到端传播时延）即可知道有没有发生碰撞。这个时间也叫作争用期，又称作碰撞窗口**

**每个站在自己发送数据后的一小段时间内，存在遭遇碰撞的可能性。这段时间取决于另一个发送数据的站到本站的距离。**以太网不能保证某一时间内一定能把数据帧成功发出，即**发送的不确定性**

**经过争用期后还没有检测到碰撞，才能肯定这次发送不会发生碰撞**

以太网使用**截断二进制指数退避算法来确定碰撞后的重传时机**。它让发生碰撞的站停止发送数据后，不是等待信道变为空闲后立即再重发数据，而是**推迟或叫作退避一个随机的时间**

**截断二进制指数退避算法要点：**

- 争用期具体时间为51.2us，10Mb/s的以太网在争用期可发送512bit，即64个字节。争用期是512**比特时间（1比特时间就是发送1比特所需要的时间）**，它和数据率密切相关
- 从离散的整数集合（0,1，...，2^k-1）中随机选取一个数，记做r，**重传推后的时间就是r倍争用期**。参数k的值=min(重传次数，10)
- 重传达到16次还不能成功时，则丢弃该帧并报告高层

该算法中若发生多次连续冲突，代表有较多站点参与争用信道，重传需推迟的平均时间也会随次数增大，即**动态退避**。因此该算法可以减小发生碰撞的概率，有利于系统稳定

适配器对过去发生的碰撞无记忆功能，因此可能有些推迟好几次发送的站仍会继续等待

可能某个站发送的帧很短，但是发送完毕后发送站才检测到碰撞，不能中止发送。这样就检测不到碰撞了，因此以太网**规定了最短帧长64字节，即512bit。数据少时应该加入填充字节**。对于10Mb/s的以太网，发送512bit需51.2us，也就是争用期

**以太网在发送数据时，在争用期（64字节）没有发生碰撞，那么后续发送的数据一定不会发生冲突。**发生碰撞一定在前64字节之内。**由于发生冲突就会中止，凡是长度小于64字节的帧都是由于冲突而异常中止的无效帧**

**当发送数据的站一旦发现发生了碰撞时，还需要继续发送32或48比特的人为干扰信号，以便让所有用户都知道发生了碰撞。也就是强化碰撞**

**以太网还规定了帧间最小间隔是9.6us，相当于96比特时间，这样可以使刚刚收到数据帧的站的接收缓存来得及清理，做好接收下一帧的准备**

**注：以太网发送完每一帧，一定要把已发送的帧暂时保留一下。发生碰撞后还需要重传**

### 4、使用广播信号的以太网

#### 1、使用集线器的星形拓扑

传统以太网发展到使用更便宜和灵活的双绞线，它采用星形拓扑，在星形的中心增加了一种可靠性非常高的设备，叫作**集线器（hub）**

![](D:\office\word\计算机基础\计算机网络\截图\集线器.jpg)

IEEE指定了星形以太网10BASE-T的标准802.3i，10代表10Mb/s，BASE代表信号是基带信号，T代表双绞线。它的通信距离短，每个站到集线器的距离不超过100m。**10BASE-T双绞线以太网的出现是局域网发展史上的重要里程碑**

**集线器特点**：

- 表面上看使用集线器的局域网在物理上是一个星型网，但集线器是使用电子器件来模拟实际电缆线的工作，因此整个系统仍然是像传统以太网那样运行。**使用集线器的以太网在逻辑上仍然是一个总线网，各站共享逻辑上的总线，仍使用CSMA/CD协议**
- 集线器有许多接口
- **集线器工作在物理层，每个接口只是简单地转发比特，不进行碰撞检测**
- 集线器有专门的芯片进行自适应串音回波抵消，可以使接口转发出去的较强信号不会对接收到的较弱信号产生干扰
- 集线器一般都有少量的容错能力和网络管理功能，当一个适配器出现故障不停发送以太网帧时，集线器可以检测出这个问题，在内部断开与它的连线，保证以太网的正常工作。
- 集线器本身必须非常可靠，它的全部网络功能都以模块方式实现，出故障或断点可更换或新增模块。它上面的指示灯还可以显示网络故障，方便网络管理。现在的堆叠式集线器可由4到8个集线器堆叠起来使用

802.3标准还可以使用光纤作为传输媒体，相应的标准是10BASE-F系列，F代表光纤。它用于集线器之间的远程连接

#### 2、以太网的信道利用率

由于多个站在以太网上同时工作可能会发生碰撞，这时信道资源实际上是被浪费了。以太网的总信道利用率不能达到100%
$$
a=\frac{\Gamma}{T0}
$$
a是以太网单程端到端时延$\Gamma$和帧的发送时间T0之比。

当`a -> 0` 时，表示一旦发生碰撞，就可以立即检测出来并立即停止发送。此时信道资源被浪费的时间就非常少

当a越大，表示争用期所占的比例越大，每发生一次碰撞就会浪费不少的信道资源，明显降低信道利用率

**当数据率一定时，以太网的连线长度会受到限制（否则分子的数值会太大），同时以太网的帧长不能太短（否则T0会太小）**

成功发送一个帧需要占用信道的时间是T0+$\Gamma$，比帧的发送时间T0要多一个$\Gamma$。这是由于一个站发送最后一个比特时，这个比特还需在以太网传播。最极端的情况就是发送站在传输媒体的一端，需要传输到另一端。必须经过T0+$\Gamma$的时间后以太网才会进入空闲状态

理想状况无任何碰撞，此时极限信道利用率为：
$$
Smax=\frac{T0}{T0+\Gamma}=\frac{1}{1+a}
$$
**只有当参数a远小于1才能得到尽可能高的极限信道利用率；反之参数a远大于1时实际的信道利用率就很低**

#### 3、以太网的MAC层

**介质访问控制（媒体接入控制）MAC（medium access control）**

局域网中的**硬件地址又叫做物理地址或MAC地址**，它在MAC帧中

名字指出我们所要寻找的那个资源，地址指出此资源在何处，路由告诉我们如何到达该处。但是这句话不完全准确

IEEE 802标准为局域网**规定了一种48位的全球地址**，是指局域网上的每一台计算机中**固化在适配器的ROM中的地址**。计算机的适配器更换之后它在局域网中的地址也就改变了，虽然它的地理位置包括局域网都没改变。同理，只要适配器不变，地理位置改变或局域网改变不会影响计算机的地址

**局域网的地址严格来说是每个站的名字或标识符，但还是习惯叫它地址**

**IEEE 802标准规定MAC地址采用6字节（48位）或2字节（16位）其中的一种**，6字节的地址字段可让全世界所有局域网适配器都具有不同的地址，因此现在一般都是用6字节的MAC地址

**前3个字节是组织唯一标识符OUI（organizationally unique identifier），也叫作公司标识符。后3个字节是厂家自行指派，叫扩展标识符**

当路由器通过适配器连接到局域网时，适配器上的硬件地址就用来标志路由器的某个接口。若路由器同时连接到两个网络，那么它就需要两个适配器和两个硬件地址

**帧的三种形式：**

- **单播（unicast）帧**   一对一，收到帧的MAC地址和本站的硬件地址相同
- **广播（broadcast）帧**    一对全体，即发送给本局域网上所有站点的帧
- **多播（multicast）帧**      一对多，发送给本局域网上部分站点的帧

所有适配器都应该能识别单播和广播地址。以太网适配器还可设置**混杂方式**，只要有帧就悄悄接收，不管其发往哪个站，这实际就是窃听其他站点的通信

##### MAC帧的格式

这是DIX Ethernet V2标准，此以太网V2标准使用最多

![](D:\office\word\计算机基础\计算机网络\截图\MAC帧的格式.jpg)

类型字段用来标志上一层使用的是什么协议，以便将MAC帧的数据交给上一层的这个协议

**数据字段的长度最小是46字节，它是用帧的最小长度64字节减去18字节的首部和尾部得来**。若小于46字节则会加入填充字段，MAC子层会将填充字段和数据一起交给上层协议，因此上层协议必须有识别有效数据字段的功能。比如IP协议中有总长度字段，总长度+填充字段长度=MAC帧中数据字段的长度

当发送方将一个以太网帧发送完毕后，就不再发送其他码元，此时电压就不再变化。接收方可很容易地找到以太网帧结束的地方

前8个字节用于保证接收端适配器的时钟与到达的比特流同步，否则MAC帧的前若干位就无法接收。**前同步码和帧开始定界符**的作用是使接收端的适配器在接收MAC帧时能迅速调整期时钟，使它和发送端的时钟同步（即实现位同步）。最后两位连续的1用来告诉适配器MAC帧的信息马上就到，注意接收

**以太网上传送数据时以帧为单位传送，各帧之间有一定的间隙**。接收端只需找到帧开始定界符，后面连续到达的比特流就属于同一个MAC帧。以太网不需要使用帧结束定界符，也不需要插入字节来保证透明传输

**无效的MAC帧：**

- 帧的长度不是整数个字节
- FCS查出有差错
- 数据字段的长度不在给定范围内（46到1500）

### 5、扩展的以太网

**扩展的以太网在网络层看来仍然是一个网络**

#### 在物理层扩展以太网

过去可以用转发器来扩展以太网的地理覆盖范围，现在扩展主机和集线器之间的距离可以使用光纤和一对光纤调制解调器（电信号和光信号的转换）

#### 在数据链路层扩展以太网

可以使用网桥（bridge），它工作在**数据链路层**，根据MAC帧的目的地址对其进行转发和过滤

##### 网桥的内部结构

![](D:\office\word\计算机基础\计算机网络\截图\网桥的工作原理.jpg)

最简单的网桥有两个接口，复杂的可有更多。两个以太网通过网桥连接后可形成覆盖范围更大的以太网，原来的每个以太网称作**网段（segment）**

网桥依靠**转发表（转发数据库或路由目录）**来转发帧

**网桥能将一个网段的帧在查找转发表后发送给另一个网段。**

若网桥从接口1收到A发给B的帧，会丢弃这个帧。因为转发表指出转发给B的帧应该从接口1转发出去，现在是从接口1收到，说明A和B同处一个网段，不需要借助网桥转发

**网桥通过内部的接口管理软件和网桥协议实体完成上述操作**

**网桥的好处：**

- **过滤通信量，增大吞吐量**。网桥工作在MAC子层，**可使以太网的各个网段成为隔离开的碰撞域**。物理层的转发器则没有这种过滤通信量的功能。在不同网段上的通信不会相互干扰。当然，若A和C通信，则需要经过网桥的转发，此时这两个网段则不能再有其他站点进行通信（此时E和F仍然可以通信）

![](D:\office\word\计算机基础\计算机网络\截图\网桥的好处.jpg)

- 扩大物理范围
- 提高可靠性，网络出现故障时只影响个别网段
- 可互连不同的物理层、不同MAC子层和不同速率

网桥也有缺点：

- 网桥对接收的帧要先存储和查找转发表之后才进行转发，转发前还要执行CSMA/CD算法，增加了时延
- MAC子层无流量控制功能，网络负荷很重时，网桥中的缓存的存储空间可能不够而发生溢出，导致帧丢失
- 网桥只适合于用户数不多和通信录不太大的以太网，否则会因传播过多的广播信息产生网络拥塞，即**广播风暴**

**有时在两个网桥间，还可使用一段点到点链路，可采用PPP协议。网桥在转发帧时，不改变帧的源地址**

|                  | 网桥和集线器（转发器）的区别                           |
| ---------------- | ------------------------------------------------------ |
| 网桥             | 存储转发，先把整个帧收下来再进行处理，不需要管目的地址 |
| 集线器（转发器） | 逐比特转发                                             |

##### **透明网桥**

目前使用最多的网桥是透明网桥（transparent bridge），透明是指以太网上的站点不知道所发送的帧将经过哪几个网桥，透明网桥**是即插即用的设备。只要将它接入局域网，不用人工配置转发表网桥就能工作**

当网桥刚刚接到以太网时，转发表是空的。它会按照**自学习**算法处理收到的帧，从而逐步建立起转发表并按照它将帧转发出去

**自学习算法的原理**

**若从某个站A发出的帧从接口X进入了某网桥，则从这个接口出发沿相反方向一定可以把一个帧传送到A**。因此网桥只要收到一个帧，**就记下它的源地址和进入网桥的接口**，然后就可以将源地址和接口写到**转发表中的地址栏和转发接口栏**。转发时根据帧中目的地址进行转发

**显然，若网络上的每个站都发送过帧，则每个站的地址最终都会记录在网桥的转发表中**

![](D:\office\word\计算机基础\计算机网络\截图\网桥的自学习算法.jpg)

A和B在一个网段中，A向B发送帧时**站点B和网桥1都能收到A发送的帧，网桥1会先按源地址A查找转发表，由于网桥1此时没A的地址，因此会将A的地址和接口1写入转发表。即以后要发送帧给A时，通过接口1转发。接着再按目的地址B查找转发表，当前还没有B地址，于是通过除了收到它的接口1之外的所有接口转发该帧，因此网桥2从它的接口1收到了该帧**

网桥2按同样的方式处理收到的帧，它也会先写入A地址和接口1，由于它也无B地址，再通过除了接口1之外的所有接口转发该帧。

**它们这样做的目的是通过盲目转发这种自学习的方式逐步弄清楚所连接的网络拓扑，建立起自己的转发表**

**B发向A时，转发表中没有B，它会先记录源地址B，再在转发表中查找目的地址A，发现A的接口也是该帧进入的接口1， 则丢弃该帧，不再继续转发。网桥会丢弃这种在转发表中目标地址的接口和进入网桥的接口相同的帧。**

网桥的转发表实际上还会**记录帧进入网桥的时间**，因为以太网的拓扑可能经常会发生变化，站点也可能会更换适配器（这就改变了站点的地址）。

**这样就可以在转发表中只保留网络拓扑的最新状态信息，接口管理软件会周期性扫描转发表中的项目，删除一定时间以前（比如几分钟）登记的内容**

透明网桥还使用了一个**生成树算法**，互连的网桥彼此通信之后，就能找到原来的网络拓扑的一个子集。**这个子集中整个连通的网络不存在回路，任何两个站点间只有一条路径**。这样可以**避免转发的帧在网络中不断地兜圈，使网络资源不断地白白消耗**。为了反应拓扑变化，生成树山的根网桥每隔一段时间还要对生成树的拓扑进行更新

**注：透明网桥最大的优点是容易安装，但是网络资源的利用还不够充分，生成树也不能保证所使用的路由最佳，也不能在不同的链路中进行负载均衡**

##### 源路由网桥

**源路由网桥由发送帧的源站负责路由选择，它在发送帧时将详细的路由信息放在帧首部**

源站会以**广播形式**向需通信的目的站发送一个**发现帧作为探测**，它们在整个扩展的以太网中沿所有可能的路由传送，传送时每个发送帧都会**记录所经过的路由**。这些发现帧到达目的站时就沿着各自的路由返回源站，**源站会选择一个最佳路由，以后凡是从这个源站向该目的站发送的帧首部，都需要携带这一确定的路由信息**

发现帧的另一个作用**是帮助源站确定整个网络可通过的帧的最大长度**

源路由网桥对主机不透明，主机必须知道网桥的标识和连接到哪一个网段上，使用它可以利用最佳路由

若在两个以太网之间使用并联的源路由网桥，可使得通信量较为平均的分配给每个网桥

##### 多接口网桥——以太网交换机

**交换式集线器（switching hub），也叫作以太网交换机、第二层交换机**可明显提高以太网的性能，表明这种交换机工作在**数据链路层**

交换机没有明确的概念，现在的交换机混杂了网桥和路由器的功能。

一般网桥的接口只有2到4个，而以太网交换机则一般有十几个接口，**它实质上是一个多接口的网桥，它的每个接口都直接和单个主机或集线器相连（普通网桥的接口往往是连接到一个网段），一般工作在全双工方式**

**主机需要通信时，交换机能同时连通许多对接口，使每一对相互通信的主机都能像独占传输媒体一样，无碰撞地传输数据**

以太网交换机也是即插即用，帧转发表同样采用自学习算法，两个站通信完成则断开连接，它内部有专用的交换结构芯片，交换效率较高

对于普通的10Mbps的共享式以太网，n个用户中每个用户的平均带宽是总带宽的1/n，而以太网交换机中是独占的，对于有n个接口的交换机总容量为n*10Mbps。这是以太网交换机的最大优点

利用以太网交换机可以方便实现**虚拟局域网VLAN（virtual LAN）**

VLAN是由一些局域网网段构成的**和物理位置无关的逻辑组**，它们有共同的需求。每个VLAN的帧都有明确的标识符，指明发送这个帧的工作站属于哪个VLAN。

![](D:\office\word\计算机基础\计算机网络\截图\虚拟局域网.jpg)

图中有三个虚拟局域网，**每个站可收到同一个虚拟局域网上的其他成员所发出的广播。其他虚拟局域网中则接收不到**。这样虚拟局域网就限制了接收广播信息的工作站数，**使得网络不会因传播过多的广播信息（即广播风暴）而出现性能恶化**

### 6、高速以太网

**速度达到或超过100Mbps的以太网叫作高速以太网**

#### 使用以太网进行宽带接入

以太网接入的重要特点是可以提供双向的宽带通信，并且可以根据需求灵活地进行带宽升级。

当城域网或广域网都采用吉比特或10吉比特以太网时，采用以太网接入可以实现端到端的以太网传输，不需要再进行帧格式的转换，可以提高数据的传输效率和降低传输成本

以太网的帧格式中地址字段部分没有用户名字段，也没有让用户键入密码来鉴别用户身份的过程，**因此有人提出将PPP协议中的PPP帧再封装到以太网中来传输，即PPPoE(PPP over Ethernet)**

用户在PPPoE弹出的窗口中输入网络运营商处购买的用户名和密码即可进行宽带上网，从用户的PC到户外第一个以太网交换机的带宽能得到保证，这是用户独占。但是这个以太网交换机到上一级的交换机是许多用户共享的

## 四、网络层

### 1、网络层提供的两种服务

传统电信网主要业务是提供电话服务，它采用面向连接的通信方式使电信网向用户（即电话机）提供可靠的传输服务。这种端到端的可靠传输服务对电话业务很合适，由于电话机非常简单，无智能和差错处理能力，因此电信网必须将话音信号可靠地传送到对方的电话机。计算机进行通信时也可以先建立连接（在分组交换中建立一条虚电路VC（virtual circuit）），以保证双方通信所需的一切网络资源。

计算机是智能的，有很强的差错处理能力，因特网采用了和电信网完全不同的设计思路

**网络层向上只提供简单灵活的、无连接的、尽最大努力交付的数据报服务，网络在发送分组时不需要先建立连接。每个分组（IP数据报）独立发送，与前后分组无关（不进行编号）。网络层不提供服务质量的承诺**

传送的分组可能出错、丢失、重复和失序（不按序到达终点），当然也不保证分组交付的时限。

由于传输网络不提供端到端的可靠传输服务，路由器就可以做得比较简单和价格低廉（和电信网的交换价相比）。若主机（端系统）中的进程之间的通信要是可靠的，那么就由网络主机中的运输层负责（差错处理、流量控制等）。网络的造价大大降低，运行方式灵活，能适应多种应用

### 2、网际协议IP

网际协议IP是TCP/IP体系中两个最主要的协议之一，也是最重要的因特网标准协议之一。与IP协议配套使用的还有三个协议：

- **地址解析协议ARP（address resolution protocol）**,逆地址解析协议RARP现在已经淘汰
- **网际控制报文协议ICMP（internet control message protocol）**
- **网际组管理协议IGMP（internet group management protocol）**

![](D:\office\word\计算机基础\计算机网络\截图\网络层协议.jpg)

ARP在最下面，因为IP经常使用这个协议。ICMP和IGMP在上部，因为它们要使用IP协议。

网际协议IP是用来使互连起来的许多计算机网络能够进行通信，**因此TCP/IP体系中的网络层也叫作网际层或IP层**

#### 虚拟互连网络

由于用户的需求是多种多样的，没有一种单一的网络能够适应所有用户的需求。将网络互相连接起来要使用一些**中间设备**。根据中间设备所在的层次，**可以有以下四种不同的中间设备：**

- 物理层使用的中间设备叫做**转发器（repeater）**
- 数据链路层使用的中间设备叫做**网桥或桥接器（bridge）**
- 网络层使用的中间设备叫做**路由器（router）**
- 在网络层以上使用的中间设备叫做**网关（gateway）**，用网关连接两个不兼容的系统需要在高层进行协议的转换

当中间设备是转发器或网桥时，这仅仅是把一个网络扩大了，从网络层的角度看，这仍然是一个网络，一般不叫作网络互连。网关比较复杂，目前使用得较少。**因此我们讨论网络互连时，都是指用路由器进行网络互连和路由选择。**

路由器其实就是一台专用计算机，用来在互联网中进行路由选择。**由于历史原因，许多TCP/IP的文献曾经把路由器也叫作网关**

TCP/IP体系在网络互连上采用的做法是在网络层采用了标准化协议，但相互连接的网络则可以是异构的。参加互连的计算机网络都使用相同的**网际协议IP**，因此可以把互连后的计算机网络看成是**虚拟互连网络，也就是逻辑互连网络，互连起来的各种物理网络的异构性是客观存在的，利用IP协议就可以使这些性能各异的网络在网络层上看起来好像是一个统一的网络。这种网络简称IP网**

IP网的好处：当IP网上的主机进行通信时，就好像在一个单个网络上通信一样，它们看不见互连的各网络的具体异构细节（如具体的编址方案。路由选择协议等等）

![](D:\office\word\计算机基础\计算机网络\截图\IP网.jpg)

#### 分类的IP地址

**IP地址及其表示方法**

整个因特网就是一个**单一的、抽象的网络，IP地址就是给因特网上的每个主机（或路由器）的每一个接口分配一个在全世界范围是唯一的32位的标识符，IP地址的结构使我们可以在因特网上很方便地进行寻址。**IP地址现在由**因特网名字和数字分配机构ICANN（internet corporation for assigned names and numbers）**进行分配。

IP地址的编址方法共经过了三个历史阶段：

- **分类的IP地址**，这是最基本的编址方法，在1981年就通过了相应的标准协议
- **子网的划分**，这是对最基本的编址方法的改进
- **构成超网**，这是比较新的无分类编址方法

这里讨论分类的IP地址。**分类的IP地址就是将IP地址划分为若干个固定类，每一类地址都由两个固定长度的字段组成，第一个字段是是网络号（net-id），它标志主机（或路由器）所连接到的网络。一个网络号在整个因特网范围内必须是唯一的；第二个字段是主机号（host-id），它标志该主机（或路由器）**

**一个主机号在它前面的网络号所指明的网络范围内必须是唯一的，因此一个IP地址在整个因特网范围内是唯一的**。IP地址不仅仅指明一个主机，而且指明了主机所连接到的网络

当然现在广泛使用**无分类 IP 地址**进行路由选择，分类的地址已经成为历史。

这种两级的IP地址可记为：

```
IP地址 ::={<网络号>，<主机号>}  //::=的意思是定义为
```

![](D:\office\word\计算机基础\计算机网络\截图\IP地址中的网络号字段和主机号字段.jpg)



A、B、C类地址都是单播地址（一对一通信），是最常用的，它们的网络号字段最前面有1-3位的类别位。

A类网络号字段只有7位可使用，可指派的网络号是126（2^7-2）个。减2的原因是全0的IP地址是个保留地址，代表本网络；127（01111111）保留作为本地软件**环回测试本主机的进程之间的通信来使用，不会将数据报发送到任何网络，本主机中的协议软件会处理其中的数据**。

**点分十进制记法：每8位可以用等效的十进制数字表示，并在这些数字之间加上一个点。**

![](D:\office\word\计算机基础\计算机网络\截图\点分十进制.jpg)

**IP地址的特点：**

1. 每一个 IP 地址都是由**网络号和主机号两部分组成**，是一种分等级的地址结构。这种结构的好处：
2. ​	a、IP 地址管理机构在分配 IP 地址时只分配网络号，而主机号由得到网络号的单位内部自行分配。方便IP地址的管理

3. ​	b、**路由器仅根据目的主机所连接的网络号来转发分组而不考虑主机号**。这使路由表中的项目数大幅减少，减小了路由表的存储空间和查找路由表的时间。

4. IP 地址是标志一台主机（或路由器）和一条链路的**接口**。**如果一台主机同时连接到两个网络，它就有两个 IP 地址，其网络号必须是不同的，这种主机叫作多归属主机**
5. ​	**注：每个路由器至少连接到两个网络，所以一个路由器至少有两个不同的 IP 地址。**

6. 因特网中**一个网络指的是具有相同网络号的主机的集合**。所以用转发器或网桥连接起来的若干局域网仍是一个网络，它们都有相同的网络号
7. IP 地址中，所有分配到网络号的网络都是平等的（平等指因特网同等对待每个IP地址），不管它的范围多大或多小。

注：两个路由器直接相连时，连线两端的接口处可分配也可不分配IP地址。若分配了，则这一段连线就构成了一种只包含一段线路的特殊网络，叫作无编号网络或无名网络。但为了节省IP地址资源，现在对于这种特殊的网络常常不分配IP地址

#### IP地址和硬件地址

![](D:\office\word\计算机基础\计算机网络\截图\IP地址和硬件地址.jpg)

**硬件地址（又称物理地址、MAC地址）**是数据链路层和物理层使用的地址。MAC帧传送时使用的源地址和目的地址都属于硬件地址，放在 MAC 帧的首部。

**IP 地址**是网络层和以上各层使用的地址，是一种**逻辑地址（因为IP地址是用软件实现的）**。放在 IP 数据报的首部。

发送数据时，数据从高层下到低层，然后再到通信链路上传输。使用IP地址的IP数据报一旦交给了数据链路层，就被封装成MAC帧。**数据链路层看不见数据报的IP地址**

![](D:\office\word\计算机基础\计算机网络\截图\不同层次上的地址.jpg)

**注意：**

1. 在 IP 层抽象的互联网上只能看到 IP 数据报。虽然信息要经过路由器 R1 和 R2 的转发，但是 **IP 数据报首部中的源地址和目的地址始终是 IP1 和 IP2。**
2. 虽然 IP 数据报首部有源地址，**但路由器只根据目的站的 IP 地址的网络号进行路由选择。**
3. 在局域网的链路层，只能看见 MAC 帧。**MAC 帧在不同网络上传送时，MAC 帧首部中的源地址和目的地址要发生变化。在上面的IP层看不到这些MAC帧首部的变化**
4. **IP 层抽象的互联网屏蔽了下层的复杂细节**。只要在网络层上，就可以使用统一的、抽象的 IP 地址来研究主机和主机或路由器之间的通信。

#### 地址解析协议ARP

ARP协议的作用是从网络层使用的IP地址解析出在数据链路层使用的硬件地址

网络层用的是 IP 地址，但实际网络的链路上传送数据帧时还是要用硬件地址。IP地址和硬件地址之间格式不同，不存在简单的映射关系

![](D:\office\word\计算机基础\计算机网络\截图\ARP协议的作用.jpg)

**ARP协议的要点**

每台主机都有一个 **ARP 高速缓存**，里面**有本局域网上的各主机和路由器的 IP 地址到硬件地址的映射表，此表还经常动态更新。映射表中的每个映射地址项目都有生存时间，超过生存时间的项目会被删掉。**

ARP 解决的是**同一个局域网上**主机或路由器的 IP 地址到硬件地址的映射问题。它无法解析另一个局域网上主机的硬件地址，实际上也不需要。

**当主机 A 向本局域网上的主机 B 发送 IP 数据报时有两种情况：**

1. 主机 A 的 ARP 高速缓存的映射表中有主机 B 的 IP 地址，就查出对应的硬件地址并且写入 MAC 帧，然后通过局域网把该 MAC 帧发给此硬件地址。

2. 主机 A 的 ARP 高速缓存中没有 B 的 IP 地址。此时按以下步骤找出 B 的硬件地址：

3. - 主机 A 自动运行 ARP ，ARP 进程在本局域网上广播发送一个 **ARP 请求分组**。分组中指明了**自己的 IP 地址与硬件地址，以及主机 B 的 IP 地址，表示想知道主机B的硬件地址**
   - 本局域网上所有主机上运行的 ARP 进程都受到这个 ARP 请求分组。
   - 主机 B 的 IP 地址与 ARP 请求分组中要查询的 IP 地址一致，收下分组，并向主机 A 发送ARP响应分组，在其中写入自己的硬件地址。其他主机则不作响应。
   - 主机 A 收到主机 B 的响应分组后，把主机 B 的 IP 地址到硬件地址的映射写入 ARP 高速缓存中。 

![](D:\office\word\计算机基础\计算机网络\截图\ARP协议的工作原理.jpg)

**注：ARP请求分组是广播发送的，但是ARP响应分组是普通的单播，即从一个源地址发送到一个目的地址。**

**主机A向B发送数据报时，可能以后主机B也需要向A发送ARP请求分组，因此A将自己的IP地址到硬件地址的映射写入请求分组，B收到后就将这一地址映射写入自己的ARP高速缓存中，减少网络上的通信量。**

**使用 ARP 的四种典型情况：**

1. 发送方是主机，要把 IP 数据报发到同一个网络上的另一台主机，如从 H1 到 H2，这时 H1 发送 ARP 请求分组（在网 1 上广播）找到 H2 的硬件地址。
2. 发送方是主机，要把 IP 报发到另一个网络上的某一台主机，如从 H1 到 H3，这时 H1 发送 ARP 请求分组（在网 1 上广播）找到网 1 上的一个路由器 R1 的硬件地址。剩下的事情由 R1 完成。
3. 发送方是路由器，要把 IP 报转发到与它连接在同一个网络上的主机，如 R1 到 H3，这时 R1 发送 ARP 请求分组（在网 2 上广播）找到主机 H3 的硬件地址。
4. 发送方是路由器，要把 IP 报转发到另一个网络上的一台主机，如 R1 到 H4，这时这时 R1 发送 ARP 请求分组（在网 2 上广播）找到本网络上另一个路由器R2的硬件地址，剩下的工作由这个路由器R2完成

![](D:\office\word\计算机基础\计算机网络\截图\使用ARP的四种典型情况.jpg)

总的来说，当发送方与接收方不在同一个网络时，要通过同时位于两个或更多个网络上的路由器来中转，而 ARP 协议则用于每个局域网内部的地址解析。

由于全世界存在各种各样的网络，它们使用不同的硬件地址，这些异构网络要能够互相通信就必须进行非常复杂的硬件地址转换工作，由用户主机来完成几乎不可能。统一的IP地址把这个问题解决了，调用ARP的过程都是软件自动进行的，对用户透明。因此不直接使用硬件地址进行通信。

#### IP数据报的格式

TCP/IP标准中各种数据格式一般**以32位（4字节）为单位**来描述

![](D:\office\word\计算机基础\计算机网络\截图\IP数据报的格式.jpg)

一个 IP 数据报由首部和数据两部分组成。**首部包括两部分**，前一部分是固定长度，共 20 字节，这是所有IP数据报必须具有的。在它后面是一些可选字段，长度可变。

**IP 数据报首部的固定部分的各字段：**

1. 版本。占 4 位，即IP协议的版本。通信双方使用的 IP 协议的版本必须一致。目前广泛使用的IP协议版本号为4（即IPv4）
2. **首部长度。** 占 4 位，最小值是5，最大值是 15，注意其表示的数的单位是 4 字节，也就是首部最大长度为 15*4=60 字节。首部长度必须是 4 字节的整数倍，因此可选字段后面还有一个填充字段。
3. 区分服务。占 8 位，旧标准叫作服务类型。一般不使用，只有使用**区分服务DS（different service）** 时此字段才有意义，根据字段的数值为提供不同等级的服务质量。
4. **总长度。**占 16 位，最大值是 2^16-1（65535），**是首部和数据部分的长度和，单位是字节**。IP 数据报的总长度还**受到数据链路层当中数据帧的数据字段最大长度MTU的限制**，因此不能超过它。如果长度过长需要进行分片。分片后总长度指的是该分片的首部长度和数据长度之和。
5. **标识。** 占 16 位。IP软件在存储器中维持一个计数器，每产生一个数据报则加1，并将此值赋给标识字段。**但标识不是序号，因为IP是无连接服务，数据报不存在按序接收的问题。同一个数据报的不同分片中标识相同。因此接收方能根据标识将不同分片重装为原本的数据报。**
6. **标志。**占 3 位。**最低位MF（more fragment）**为 1 表示后面还有分片，为 0 表示这是最后一个分片。**中间位DF（don't fragment）**为 1 表示不能分片，为 0 表示可以分片。首位没有含义。
7. **片偏移。**占 13 位。**片偏移指出较长的分组分片后，某片在原分组的相对位置。即相对于用户数据字段的起点来说，该片从何处开始。**它的单位是 8 字节，故每个分片的长度是 8 字节的整数倍。
8. **生存时间，TTL（time to live）**。占 8 位。**表明数据报在网络中的寿命。单位是跳数**，指明了数据报在互联网中至多可经过多少个路由器，TTL值为0则丢弃这个数据报，最大值是255。若将它设为1，则代表只能在本局域网中传送
9. **协议。**占 8 位。指明了数据报携带的数据使用了哪种协议。
10. **首部检验和。**占 16 位。这个字段只检验首部，不包括数据部分，可减少计算量。数据报每经过一个路由器，路由器就要重新计算一下首部检验和。IP首部的检验和不采用复杂的CRC检测码而采用一种简单的计算方法。若首部未发生任何变化，则结果为0，可以保留这个数据报。否则即认为出现差错，将此数据报丢弃
11. 源地址。占 32 位。
12. 目的地址。占 32 位。

![](D:\office\word\计算机基础\计算机网络\截图\片偏移的例子.jpg)

**IP 数据报首部的可变部分**

长度可变，从1到40个字节不等。具有多种功能，可支持排错、测量和安全等措施，但很少使用。IPv6 已经把这部分做成固定长度的了。

#### IP层转发分组的流程

所有的分组转发都基于目的主机所在的网络，但是允许一个特例：**对特定的目的主机指明一个路由，这种方法叫作特定主机路由。**这可以方便控制网络和测试网络，同时可以在需要考虑一些安全问题时（比如对网络的连接或路由表进行排错）使用它

![](D:\office\word\计算机基础\计算机网络\截图\路由表举例.jpg)

路由器的路由表中不直接存储主机地址，而是**存储目的网络地址和对应的下一跳地址，根据目的网络地址来确定下一跳路由器，只有到达最后一个路由器时才试图向目的主机进行直接交付**

**IP数据报找到下一跳路由器的方式：**

路由器若收到待转发的数据报，从路由表中得知下一跳路由器的IP地址后，因为IP数据报中没有下一跳路由器的IP地址，因此会将这个地址交送数据链路层的网络接口软件，它使用ARP负责把下一跳路由器的IP地址转换为硬件地址，并将它放在数据链路层的MAC帧首部，根据这个硬件地址找到下一跳路由器

**注：在一个网络只有很少的对外连接时，路由器可采用默认路由来减少路由表所占的空间和搜索路由表所用的时间**

**总结出分组转发算法如下：**

1. 从数据报的首部提取出目的主机的 IP 地址 D，得出目的网络地址为 N。
2. 若 N 就是与此路由器直接相连的某个网络地址，**则直接交付**，即直接把数据报交付目的主机，不需要经过其他路由器；否则就是间接交付，执行 3。
3. 若路由表中有目的地址为 D 的特定主机路由，则把数据报传送给路由表中所指明的下一跳路由器。否则执行 4。
4. 若路由表中有到达网络 N 的路由，则把数据报传送给路由表所指明的下一跳路由器，否则执行 5。
5. 若路由表有一个默认路由，则把数据报传送给路由表所指明的默认路由器，否则执行 6。
6. 报告转发分组出错。

### 3、划分子网和构造超网

#### 从两级IP地址到三级IP地址

在ARPANET早期，IP地址的设计确实不够合理。

- IP地址空间的利用率有时很低
- 给每个物理网络分配一个网络号会使路由表变得太大，因而使网络性能变坏。
- 两级IP地址不够灵活

为了解决这些问题，1985年起在 IP 地址中又增加了一个**子网号字段，将 IP 地址分为了三级。这种方式叫作划分子网（subnetting），或子网寻址、子网路由选择**

**注：划分子网是把 IP 地址中的主机号再划分，借用若干位作为子网号，并未改变网络号。**

一个拥有许多物理网络的单位可将所属的物理网络划分为若干个子网（subnet），这是一个单位内部的事，**它对外仍然表现为一个网络。收到外来的IP数据报后，再按照目的地址转发到对应的目的子网**

```
IP地址 ::={<网络号>，<子网号>，<主机号>}
```

![](D:\office\word\计算机基础\计算机网络\截图\子网划分.jpg)

#### 子网掩码

划分子网后，IP 数据报的首部无法体现是否进行了划分。这时需要使用**子网掩码（subnet mask）**。

![](D:\office\word\计算机基础\计算机网络\截图\IP地址的各字段和子网掩码.jpg)

e中只需要**将三级IP地址的子网掩码和收到的数据报的目的IP地址逐位相与运算，即可得到子网的网络地址。这是使用子网掩码的好处，在路由器处理分组时也可采用同样的算法得到子网的网络地址**

**总结：**

从网络145.13.0.0外面看，这是普通的B类网络，子网掩码为16个连1后面跟16个连0；但是进入这个网络后（即到了路由器R1），就看到了还有许多子网，它们的子网掩码都是24个连1后面跟8个连0。在B类网络的外面和里面看到的是不一样的

现在的互联网规定所有的网络都必须使用子网掩码，**路由器的路由表中也必须有子网掩码这一栏。因此不划分子网时，也要使用子网掩码（使用默认子网掩码，它1的位置和网络号字段对应），可以方便查找路由表**

**若一个路由器连接在两个子网上就拥有两个网络地址和两个子网掩码**

路由器在和相邻路由器交换路由信息时，必须把自己所在网络或子网的子网掩码告诉对方。

![](D:\office\word\计算机基础\计算机网络\截图\默认的子网掩码.jpg)

**划分子网增加了灵活性，但减少了能够连接在网络上的主机总数**

**注：相同的IP地址和不同的子网掩码可以得出相同的网络地址，但是不同的掩码会让其中的子网数和主机数不同**

#### 使用子网时的分组转发

使用子网划分后，路由表中必须包含**目的网络地址、子网掩码和下一跳地址三项内容。**

**此时的分组转发算法如下：**

1. 从数据报的首部提取出目的主机的 IP 地址 D。
2. 判断是否为直接交付。对路由器直接相连的网络逐个检查：用各网络的子网掩码逐个与 D 按位相与，看结果是否和相应的网络地址匹配。若匹配，就直接交付；否则就是间接交付，执行 3。
3. 若路由表中有目的地址为 D 的特定主机路由，则把数据报传送给路由表中所指明的下一跳路由器。否则执行 4。
4. 对路由表中的每一行，用其中的子网掩码和 D 逐位相与，若结果与该行的**目的网络地址**匹配，则把数据报传送给该行指明的下一跳路由器，否则执行 5。
5. 若路由表有一个默认路由，则把数据报传送给路由表所指明的默认路由器，否则执行 6。
6. 报告转发分组出错。

![](D:\office\word\计算机基础\计算机网络\截图\使用子网的分组转发.jpg)

#### 无分类编址CIDR（构成超网）

**无分类编址**全名是**无分类域间路由选择 CIDR（classless inter-domain routing）**。

**CIDR 有两个主要特点：**

1. CIDR 消除了传统的 A,B,C 类地址和划分子网的概念，它把 32 位的 IP 地址分为前后两部分。**网络前缀简称前缀**用来指明网络，**后面的部分用来指明主机**。因此它使用的是两级编址，但是是**无分类的两级编址。**CIDR还使用**斜线计法或叫CIDR计法**，在IP地址后加上斜线`/`，然后写上网络前缀的位数
2. CIDR 把**前缀都相同的连续的 IP 地址组成一个 CIDR 地址块**，只要知道**该地址块中的任意一个地址，就可以知道地址块的起始地址（即最小地址）、最大地址和地址块中的地址数。**

CIDR 使用 **32 位的地址掩码（address mask）**，由一串1和一串0组成。地址掩码中 1 的个数对应的就是前缀的长度。前缀越短，其地址块包含的地址数越多。使用 CIDR 可以更有效地分配地址空间。

一个CIDR地址块中有很多地址，所以在路由表中就利用CIDR地址块来查找目的网络，这种地址的聚合叫作**路由聚合或构成超网**，它使得路由表中的一个项目可以表示原来传统分类地址的很多个路由。  

**最长前缀匹配**

CIDR 中，路由表的每个项目由网络前缀和下一跳地址组成，查找时可能得到不止一个匹配结果。这时**应该从匹配结果中选择具有最长网络前缀的路由，因为它对应的地址块最小，路由就越具体**

**使用二叉线索查找路由表**

由于需要寻找最长前缀匹配，路由表的查找过程变复杂了

无分类编址的路由表通常存放在一个**二叉线索树**中。

树的根结点下面每一层对应 IP 地址中的一位，下面最多有 32 层。

每个IP地址有一个**唯一前缀**，代表在表中的所有IP地址中，此前缀是唯一的，查找时只要和唯一前缀相匹配就行

给定一个 IP 地址，查找它是否在该项目表中，只需在二叉线索树中一层层对应向下寻找，若中间无法在二叉树中找到对应分支，表明这个地址不在这个二叉线索中。

![](D:\office\word\计算机基础\计算机网络\截图\二叉线索树.jpg)

图中每个小方框是一个叶结点，每一个都代表一个唯一前缀

每个叶结点需要包含对应的网络前缀和子网掩码，将目的地址和子网掩码进行与运算，查看结果是否和网络前缀匹配

**二叉线索只是提供了快速在路由表中找到匹配的叶结点的机制，是否和网络前缀匹配则还需要和子网掩码进行一次逻辑与的运算**

为了提高二叉线索的查找速度，广泛使用了各种**压缩技术**，比如最后两个地址前四位相同，就可以跳过前四位直接从第五位开始，减少查找的时间

### 4、网际控制报文协议ICMP

**为了更加有效地转发IP数据报和提高交付成功的机会，在网际层使用了ICMP（internet control message protocol）**，它允许主机或路由器报告差错情况和提供有关异常情况的报告

ICMP是IP层的协议，**它的报文装在IP数据报中的数据部分**

![](D:\office\word\计算机基础\计算机网络\截图\ICMP的格式.jpg)

代码字段是为了进一步区分某种类型中的几种不同情况

检验和字段用来检验整个ICMP报文

#### ICMP报文的种类

ICMP报文的种类有两种：**ICMP差错报告报文和ICMP询问报文**

![](D:\office\word\计算机基础\计算机网络\截图\ICMP报文的类型.jpg)

 **5种常用的 ICMP 差错报告报文：**

1. **终点不可达**：当路由器或主机不能交付数据报时就**向源点**发送此报文。
2. **源点抑制：** 路由器或主机由于拥塞而丢弃数据报时，向源点发送此报文，可以使源点发送数据报的速率放慢
3. **时间超过**：路由器收到生存时间为 0 的报文时，除丢弃该数据报外，还要向源点发送此报文。当终点在预先规定时间内未收到一个数据报的全部分片时，就丢弃已收到的所有分片，并向源点发送此报文。
4. **参数问题**：当路由器或目的主机收到的数据报的首部中有的字段值不正确时，就丢弃该数据报并向源点发送此报文。
5. **改变路由（重定向）：**路由器把此报文发送给主机，以告诉主机下次将数据报发给另外的路由器。

![](D:\office\word\计算机基础\计算机网络\截图\ICMP差错报告报文.jpg)

ICMP 差错报告报文的**数据字段是固定格式**的：把收到的需要进行差错报告的 IP 数据报的首部和数据字段的前 8 个字节（为了得到运输层的端口号和运输层报文的发送序号）提取出来作为 ICMP 报文的数据部分。

整个ICMP报文作为IP数据报的数据字段发送给源点

另外 2 种常用的 ICMP 询问报文：

1. **回送请求和回答：**回送请求报文是由主机或路由器向一个特定目的主机发出的询问。收到此报文的主机必须给源主机发送 ICMP 回送回答报文。用来测试目的站是否可达和了解它的状态
2. **时间戳请求和回答**：时间戳请求报文是请某台主机或路由器回答当前的日期和时间。通过它可以进行时钟同步和时间测量。

#### ICMP的应用举例

##### **PING**

ICMP 的一个重要应用是进行**分组网间探测 PING（Packet InterNet Groper）**，**以测试两台主机之间的连通性。**

PING 使用了 ICMP 回送请求和回送回答报文。它会连续发送 4 条回送请求报文。

PING 是应用层直接使用网络层 ICMP 的例子，未经过运输层的TCP或UDP。

**使用方法**：在 Windows 的 DOS 窗口中键入 **ping hostname** 即可测试本机与主机 hostname 之间的连通性，hostname 是要测试连通性的主机名或IP地址，按下回车后即可看到结果

```
ping www.baidu.com;//测试与百度之间的连通性
ping 192.168.100.5;//测试与 IP 地址为 192.168.100.5 的之间的连通性
```

##### **tracert**

**tracert** 可以用来跟踪一个分组从源点到终点的路径。

tracert 从源主机向目的主机发送一连串的 IP 数据报。数据报中封装的是**无法交付的 UDP 用户数据报**。

这些数据报中，第一个数据报的生存时间 TTL 设为 1，后面依次增长。当第 i 个数据报到达了路径上的第 i 个路由器，其 TTL 也减到了 0，此时该路由器就会发送 **ICMP 时间超过**差错报告报文给源主机。最后一个数据报到达目的主机时，TTL是1。主机不转发数据报，也不把TTL值减1。但是数据报是UDP的，因此会向源主机发送**ICMP终点不可达**差错报文。由此就可以获得到达目的主机所经过的所有路由器的 IP 地址，以及到达每一个路由器的往返时间。

**使用方法：**在 Windows 的 Dos 窗口中键入 **tracert hostname** 即可测试本机到主机 hostname 所经过的路由器。  

**注：原则上来说IP数据报经过的路由器越多，所花费的时间也会越多。但是由于因特网的拥塞程度随时在变化，很难预料，可能出现经过更多的路由器却花费更少的时间**

### 5、因特网的路由选择协议

#### 有关路由选择协议的几个基本概念

**路由选择协议的核心**是采用何种算法来获得路由表中的各项目。

**理想的路由算法：**

- 算法必须是正确和完整的，计算上应简单
- 算法应该能适应通信量和网络拓扑的变化，就是要有**自适应性**，能自适应地改变路由以均衡各链路的负载
- 算法应具有稳定性，公平的，最佳的

路由选择算法可以分为**静态路由选择策略和动态路由选择策略。**静态路由选择策略也叫作**非自适应路由选择**，特点是简单和开销小，但不能及时适应网络状态的变化。适用于简单的小网络，人工配置每一条路由

动态路由选择也叫作**自适应路由选择**，可以较好地适应网络状态的变化，但实现起来较复杂，开销比较大。适用于大网络。

**分层次的路由选择协议**

因特网采用的主要是**动态的、分布式的路由选择协议**。

由于因特网规模非常大，许多单位不愿意外界了解自己单位网络的布局细节和本部门采用的路由选择协议，但同时还希望连接到因特网上。因特网将整个互联网划分为许多较小的**自治系统AS（autonomous system）**。

一个 AS 是在单一技术管理下的一组路由器，**一个 AS 对另一个 AS 表现出的是一个单一的和一致的路由选择策略。目前互联网中，一个大的 ISP 就是一个 AS。也可以进一步划分。**

这样互联网就把路由选择协议分为了两类：

1. **内部网关协议 IGP：**如 **RIP** 和 **OSPF** 协议，是在一个 AS 内部使用的路由选择协议。每个 AS 自己决定在自己内部使用哪一种 IGP。
2. **外部网关协议 EGP**：如 **BGP-4** 协议，用在两个不同的 AS 之间的路由选择协议。每个 AS 中位于与其他 AS 交界处的路由器除了使用 IGP 外还要使用 EGP。

#### 内部网关协议RIP

RIP（routing information protocol）中文名是**路由信息协议**，是IGP中最先广泛使用的协议。RIP 是一种**分布式的基于距离向量的路由选择协议**，最大优点是简单。

RIP 协议要求每一个路由器都要维护从它自己到其他每一个目的网络的距离记录（这是一组距离，即距离向量），距离也叫作**跳数（hop count）**。**RIP 选择一条具有最少路由器的路径，一条路径最多包含15个路由器，即跳数等于16时不可达。**RIP只适用于小型互联网

路由器到直接连接的网络的跳数是1（也可以定义为0），每经过一个路由器，跳数就加1

**RIP不能在两个网络之间同时使用多条路由，它选择一条具有最少路由器的路由（即最短路由），哪怕还有另一条高速但路由器较多的路由**

RIP 和 OSPF 同为分布式路由选择协议，共同特点是**每一个路由器都要不断地和其他路由器交换路由信息。**

**RIP协议的特点：**

1. 仅和相邻路由器交换信息。
2. 交换的信息是当前本路由器知道的所有信息，即自己的路由表。交换的信息是我到本AS中所有网络的最短距离，以及到每个网络应经过的下一跳路由器
3. 按固定的时间间隔交换路由信息，比如 30s。

路由器刚开始工作时只知道直接连接的网络的距离，接着和数目有限的相邻路由器交换并更新路由信息。经过若干次更新后，所有路由器最终都会知道本AS中任何一个网络的最短距离和下一跳路由器的地址。一般情况下RIP协议可以收敛（在AS中所有结点都得到正确的路由选择信息的过程）

路由表中最主要的信息**就是到某个网络的距离（即最短距离）和应经过的下一跳地址。**路由表更新的原则是找出到每个目的网络的**最短距离**，这种更新算法也叫作**距离向量算法**

**RIP协议的报文格式**

![]()![RIP报文](D:\office\word\计算机基础\计算机网络\截图\RIP报文.jpg)

RIP问题：当网络出现故障时，要经过比较长的时间才能将信息传送到所有路由器。好消息传播得快，坏消息传播得慢

#### 内部网关协议OSPF

**OSPF（open shortest path first）开放最短路径优先**使用了Dijkstra提出的最短路径算法，它只是一个名字，不代表其他路由选择协议不是最短路径优先

OSPF 最主要的特征是**使用分布式的链路状态协议（link state protocol），适用于大型互联网。**

**OSPF的要点：**

1、向本AS中**所有路由器发送信息**，使用**洪泛法（flooding）**，路由器通过所有输出端口向所有相邻的路由器发送信息，每一个相邻路由器再将此信息发往其所有相邻的路由器，这样最终整个区域所有的路由都得到这个信息的副本。

2、发送的信息就是和本路由器**相邻的所有路由器的链路状态**，链路状态就是本路由器和哪些路由器相邻，以及该链路的度量或叫作代价（距离、费用、时延、带宽等等）

3、OSPF 只**在链路状态发生变化时**，才向本AS中的所有路由器**用洪泛法**发送信息，而不是定期交换路由表的信息

由于各路由器之间频繁交换链路状态信息，因此所有的路由器最终都能建立一个**链路状态数据库**，即全网的拓扑结构图，它在全网范围内一致（这叫作链路状态数据库的同步）

每个路由器使用其中的数据，构造出自己的路由表

**OSPF的链路状态数据库能较快更新，优点是更新过程收敛得快**

为了能用于规模很大的网络，OSPF将一个自治系统再划分为若干个更小的范围，叫作**区域**。每个区域有一个32位的区域标识符，每个区域路由器最好不超过200个

划分区域的好处：**交换链路状态信息的范围局限在每个区域而不是整个自治系统，减少整个网络的通信量**

#### 外部网关协议BGP

**BGP** 是 **BGP-4** 的简写。BGP 是**不同 AS 的路由器之间**交换路由信息的协议，是一种路径向量路由选择协议。BGP 力求寻找一条能够到达目的网络**（可达）**且比较好的路由**（不兜圈子）**，而非寻找最佳路由。

### 6、IP多播

在一对多的通信中，多播可以比单播节省很多资源。

**局域网具有硬件多播功能**，所以不需要复制分组就能使所有的多播组成员收到分组。

IP 多播所传送的分组需要使用多播 IP 地址。在传统的 IP 地址中的 D 类地址就是多播地址，每个 D 类地址可以标识一个**多播组**。

多台主机可以**加入到一个多播组中共享一个多播地址**。不同网络的主机可以加入到同一个多播组中。**每一台主机可以随时加入或离开一个多播组。**

能够运行多播协议的路由器为多播路由器。

**多播地址只能用于目的地址**，不能用于源地址。

IP 多播有两种

1. 在本局域网上硬件多播。
2. 在互联网范围内进行多播

**IGMP和多播路由选择协议**

**网际组管理协议（internet group management protocol）IGMP** 协议用于让连接在本地局域网上的多播路由器知道本局域网上是否有主机参加或退出了某个多播组。IGMP 工作在单个本地局域网内部。

因为主机随时可能加入或退出某个多播组。并且发送多播数据报的主机可以位于多播组内，也可以不位于多播组内。所以 IP 多播很复杂。

**IGMP 协议的工作内容：**

1. 当某台主机加入某个多播组时，该主机向多播组的多播地址发送一个 IGMP 报文，声明自己成为了该组的成员。本地的多播路由器收到 IGMP 报文后还要转发给其他多播路由器。
2. 组成员关系是动态的。本地多播路由器要周期性地探询本地局域网上的主机是否还是组的成员。

**多播路由选择协议**

多播路由选择协议有多种，尚未进行标准化。

多播路由选择协议在转发多播数据报时有以下三种方法：

1. 洪泛与剪除。
2. 隧道技术。
3. 基于核心的发现技术。

目前的多播路由选择协议：

1. 距离向量多播路由选择协议 DVMRP
2. 基于核心的转发树 CBT
3. 开放最短通路优先的多播扩展 MOSPF
4. 协议无关多播-稀疏方式 PIM-SM
5. 协议无关多播-密集方式 PIM-DM

## 五、运输层

### 1、运输层协议概述

**网络层为主机之间提供逻辑通信，运输层为应用进程提供端到端的逻辑通信。**逻辑通信代表从应用层看，只要将应用层报文交给下面的运输层，运输层就可以把报文传送到对方的运输层，实际上两个运输层之间并没有一条水平方向的物理连接。

通信的真正端点是**主机中的进程**，即应用进程之间的通信是端到端的通信。

**运输层的复用和分用**

复用是指在发送方不同的应用进程都可以使用同一个运输层协议传送数据（加上适当的首部）；分用是指接收方的运输层在剥去报文的首部后能够将这些数据正确交付目的应用进程

![](D:\office\word\计算机基础\计算机网络\截图2\运输层协议的作用范围.jpg)

**运输层要对收到的报文进行差错检测**。网络层中IP数据报的检验和字段只检验首部是否出现差错，不检查数据部分

#### 运输层的两个主要协议

OSI中两个对等运输实体在通信时传送的数据单位叫作**运输协议数据单元TPDU**

运输层的两个主要协议是 **传输控制协议 TCP** 和 **用户数据报协议 UDP**，他们都有复用和分用，和检错的功能。

**UDP 的特点：无连接、尽最大努力交付、面向报文、无拥塞控制**、支持一对一、一对多、多对一、多对多，**首部开销小。**

**TCP 的特点：面向连接的、点对点通信、提供可靠传输**、全双工通信、面向字节流。

**UDP用户数据报协议（user datagram protocol）**

数据单位叫作**UDP用户数据报，UDP在传送数据前不需要先建立连接，即无连接**。接收方的主机收到 UDP 后不需要发出确认。虽然UDP不提供可靠交付，但某些情况下UDP是最有效的工作方式

**TCP传输控制协议（transmission control protocol）**

TCP **提供面向连接的服务**，传送数据前必须要先建立连接，传送结束后要释放连接。TCP的数据单位叫作**TCP报文段**

**TCP 不提供广播或多播服务。**

由于TCP要提供可靠的、面向连接的运输服务，因此不可避免地增加了许多开销，如确认、流量控制、计时器和连接管理等。这会使协议数据单元的首部增大很多，还要占用许多的处理机资源

![](D:\office\word\计算机基础\计算机网络\截图2\TCP和UDP对应的应用层协议.jpg)

#### 运输层的端口

为了使运行不同操作系统的计算机应用进程能相互通信，必须使用统一的方法对应用进程进行标志。但是进程的创建和撤销是动态的，因此不能将进程作为通信的终点

解决方法是在运输层使用**协议端口号，简称端口（port）**，只要将传送的报文交到目的主机的某个合适的目的端口，剩下的工作（即最后交付目的进程）由TCP完成。

**注：这种在协议栈层间的抽象协议端口是软件端口，它是应用层的各种协议进程和运输实体进行层间交互的一种地址，和路由器或交换机上的硬件端口是不同的概念**

**运输层使用 16 位（即两字节）端口号来标志一个端口。端口号只具有本地意义，只是标志本计算机应用层中的各个进程和运输层交互时的层间接口**，不同计算机的相同端口号是无关的。

因特网上的计算机通信采用客户-服务器方式，**运输层的端口号可以分为两大类：**

- **服务器端使用的端口号**：这里又可以分为两类：
  -   **熟知端口号（系统端口号）**：数值为0~1023，这些端口号指派给了TCP/IP中最重要的一些应用程序

  ![](D:\office\word\计算机基础\计算机网络\截图2\常见的熟知端口号.jpg)

  - ​	**登记端口号**：数值为1024~49151，为没有熟知端口号的应用程序使用

- **客户端使用的端口号**：数值为49152~65535，仅在客户进程运行时才动态选择，也叫作短暂端口号。通信结束后刚刚使用的客户端口号就不复存在，可以给其他客户进程使用

### 2、用户数据报协议UDP

#### UDP概述

UDP只在IP数据报服务之上增加了很少的一点功能，即复用和分用、差错检测

**UDP的主要特点：**

- **UDP是无连接的**，发送数据之前不需要建立连接，减小了开销和发送数据之前的时延
- UDP使用**尽最大努力交付**，不保证可靠交付，主机不要维持复杂的连接状态表
- UDP是面向报文的，UDP对应用层交下来的报文**既不合并，也不拆分，保留这些报文的边界**。在添加首部后就向下交付IP层，UDP一次交付一个完整的报文，因此应用程序需选择合适大小的报文，太长的话IP层在传送时会进行分片，降低IP层的效率。反之太短会使IP数据报的首部相对太大，也会降低IP层的效率

![](D:\office\word\计算机基础\计算机网络\截图2\UDP面向报文.jpg)

- **UDP没有拥塞控制**，因此网络出现的拥塞不会使源主机的发送速率降低，这对于实时应用很重要，很多实时应用（IP电话、实时视频会议等）要求源主机以恒定的速率发送数据，并且允许在发生拥塞时丢失一些数据，但不允许数据有太大的时延。UDP正好适合这种要求
- UDP支持一对一、一对多、多对一和多对多的交互通信
- UDP的首部开销小，只有8个字节，比TCP的20个字节的首部要短

**注：实时应用使用需要使用UDP的情况下，当很多的源主机同时向网络发送高速率的实时视频流时，网络可能会发生拥塞，导致大家都无法正常接收。因此不使用拥塞控制功能的UDP可能会引起网络产生严重的拥塞问题**

**有些使用UDP的实时应用，需要对UDP的不可靠传输进行适当改进，以减少数据的丢失。在不影响实时性的前提下，可以增加提高可靠性的措施，比如前向纠错或重传已丢失的报文**

#### UDP的首部格式

UDP有两个字段：**数据字段和首部字段，首部字段只有8个字节，其中有四个字段，每个字段都是2字节**

![](D:\office\word\计算机基础\计算机网络\截图2\UDP的首部.jpg)

**UDP的首部**

- **源端口**  源端口号，需要对方回信时选用，不需要时可用全0
- **目的端口** 在终点交付报文时必须使用到
- **长度** 整个UDP用户数据报的长度，最小值为8（仅有首部）
- **检验和** 检测UDP用户数据报在传输中是否有错，有错就丢弃

若接收方UDP发现收到的报文中的目的端口号不正确（即不存在对应于该端口号的应用进程），就丢弃该报文，并且由网际控制报文协议ICMP发送**端口不可达**差错报文给发送方。之前的tracesert就是使用了一个非法UDP，达到测试目的

**UDP中检验和的计算方法有些特殊：**

计算检验和时**需要在UDP之前增加12个字节的伪首部，只有在计算时临时添加在UDP之前，得到一个临时的UDP用户数据报。伪首部既不向下传送也不向上递交**

**注：IP数据报的检验和只检验IP数据报的首部，但是UDP的检验和是把首部和数据部分一起检验**

- 发送方先将全0放入检验和字段

- 将伪首部和UDP用户数据报看成16位的字串接起来，若UDP的数据部分不是偶数个字节，则填入一个全0字节
- 按二进制反码计算这些16位字的和，将此和的二进制反码写入检验和字段后就发送此UDP
- 接收方将伪首部和UDP一起按照二进制反码求这些16位字的和。**无差错时结果应全为1，否则代表出错，接收方丢弃此UDP用户数据报（也可以上交应用层，但附上出现差错的警告）**

**这种差错检验方法的检错能力不强，但是好处是简单，处理起来快。**

### 3、传输控制协议TCP

#### TCP的主要特点

- **TCP是面向连接的运输层协议**，应用程序使用TCP协议之前，必须先建立TCP连接。传送数据完毕后必须释放已经建立的TCP连接。
- **每一条TCP连接只能有两个端点，只能是点对点的（一对一）**。
- **TCP提供可靠交付的服务**，通过TCP连接传送的数据无差错、不丢失、不重复并且按序到达
- **TCP提供全双工通信**，TCP允许通信双方的引用进程在任何时候都能发送数据，TCP连接的两端都设有发送缓存和接收缓存，用来临时存放双向通信的数据
- **面向字节流**，TCP中的流是指流入到进程或从进程流出的字节序列，虽然应用程序和TCP的交互是一次一个数据块（大小不等），但是TCP将应用程序交下来的数据仅仅看成是一连串的**无结构的字节流**，TCP不知道所传送的字节流的含义，它不保证接收方应用程序收到的数据块和发送方应用程序所发出的数据块具有对应的大小关系。**但是接收方应用程序收到的字节流必须和发送方应用程序发出的字节流完全一样**

![](D:\office\word\计算机基础\计算机网络\截图2\TCP面向流的概念.jpg)

**TCP和UDP不同，TCP并不关心应用进程一次把多长的报文发送到TCP缓存，而是根据对方给出的窗口值和当前网络拥塞程度来决定一个报文段应包含多少个字节。而UDP发送的报文长度是应用进程给出的**

若应用进程传送到TCP缓存的数据块太长，TCP就可以把它划分短些再传送；若太短也可以积累足够多的字节后再构成报文发出

#### TCP的连接

**TCP把连接作为最基本的抽象**，TCP连接就是由协议软件所提供的一种抽象。

每一条TCP连接**有两个端点，它叫作套接字（socket）或插口，端口号拼接到IP地址即构成了套接字。套接字是抽象的**

套接字的表示方法是在点分十进制的IP地址后面写上端口号，中间使用冒号或逗号隔开

**每一条TCP连接唯一地被通信两端的两个端点（即两个套接字）所确定**

**同一个IP地址可以有多个不同的TCP连接，同一个端口号也可以出现在多个不同的TCP连接中**

```
套接字socket = (IP地址：端口号)
TCP连接 ::={socket1, socket2} = {(IP1:port1), (IP2:port2)}
```

socket这个名词还可以表示其他意思，比如**允许应用程序访问连网协议的应用编程接口API，即运输层和应用层之间的一种接口，叫作socket API，简称socket**

### 4、可靠传输的工作原理

TCP发送的报文段是交给IP层的，但是IP层只能提供尽最大努力服务，即不可靠的传输。

理想的传输条件：

- 传输信道不产生差错
- 不管发送方以多快的速度发送数据，接收方总是来得及处理收到的数据

理想的传输条件下不需要采取任何措施就能够实现可靠传输，但是实际的网络都不具备这两个理想条件

**可以使用一些可靠传输协议，当出现差错时让发送方重传出现差错的数据，同时当接收方来不及处理收到的数据时，及时告知发送方适当降低发送数据的速度。**

#### 停止等待协议

**停止等待就是每发送完一个分组就停止发送，等待对方的确认。收到确认后再发送下一个分组**

![](D:\office\word\计算机基础\计算机网络\截图2\停止等待协议.jpg)

如果发送方发送的数据在传输过程丢失了，或者到达了接收方但是报文内容出了差错，那么接收方都不会发送任何信息。

**发送方只要超过了一段时间仍然没有收到确认，就认为刚才发送的分组丢失，因而重传前面发送过的分组。**这就是**超时重传**，每发送完一个分组需设置一个**超时计时器**，在它到期之前收到对方的确认则撤销此计时器。

**注意：**

1. 发送方在发送完一个分组后，**必须暂时保留已发送的分组的副本**，以在超时重传时使用，只有收到相应的确认后才能清除保留的副本
2. **分组和确认分组都需要进行编号**，以明确是哪个发出去的分组收到了确认，哪个没有收到
3. 超时计时器的重传时间**应当比数据在分组传输的平均往返时间长一些**，具体重传时间设为多少是一个很复杂的问题。因为发送出的分组到底经过哪些网络、这些网络产生多大的时延（这取决于这些网络当时的拥塞情况）都是不确定因素

**确认丢失和确认迟到**

![](D:\office\word\计算机基础\计算机网络\截图2\确认丢失和确认迟到.jpg)

**确认丢失**：

如图a，此时接收方发送的确认丢失了。当B再次受到M1分组时，**首先会丢弃这个重复分组，再向A发送确认。**

**确认迟到**：

如图b，B对分组M1的确认迟到了，此时A收到后会丢弃

**利用确认和重传机制就可以在不可靠的传输网络上实现可靠通信**

**可靠传输协议一般称为自动重传请求ARQ（automatic repeat reQuest）**，重传的请求是自动进行的，接收方不需要请求发送方重传某个出错的分组

**信道利用率**

停止等待协议的优点是简单，缺点是信道利用率太低。

为了提高传输效率，可以采用**流水线传输，即发送方可连续发送多个分组，不必每发完一个分组就停顿下来等待对方确认**。信道可以一直有数据不间断地在传送

#### 连续ARQ协议

![](D:\office\word\计算机基础\计算机网络\截图2\连续ARQ协议的工作原理.jpg)

发送方维持**发送窗口，位于其中的5个分组都可以连续发送出去，不需要等待对方确认**，这样可以提高信道利用率

**发送方每收到一个确认，就将发送窗口向前滑动一个分组的位置。**

接收方则采用**累积确认**的方式。它不必对收到的分组逐个发送确认，而是在收到几个分组后，**对按序到达的最后一个分组发送确认，代表到这个分组为止的所有分组都已经正确收到了**

**累积确认容易实现，即使确认丢失也不需要重传，缺点是不能向发送方反映出接收方已经正确收到的所有分组的信息**

### 5、TCP报文段的首部格式

TCP虽然是面向字节流的，但是TCP传送的数据单元却是报文段。

源端口和目的端口都是2个字节

![](D:\office\word\计算机基础\计算机网络\截图2\TCP的首部.jpg)

**首部各字段的作用：**

1. **序号**：在一个 TCP 连接中传送的字节流中的**每一个字节都要按顺序编号。首部中的序号字段存储本报文段发送的数据（是数据，不包含首部）的第一个字节的序号。**序号字段只有 32 位，序号值的范围是[0，2^32-1]，使用mod 2^32进行计算，**序号也叫作报文段序号**

   理解：数据部分的每个字节都会占用一个序号。

3. **确认号**：是期望收到对方下一个报文段的第一个数据字节的序号。**若确认号为 N，表明到 N-1 为止的数据都已正确收到。**

4. **数据偏移**：占4位，数据部分距报文段的起始处有多远，实际就等于首部长度。首部长度在 20~60 字节之间。数据偏移的单位是32位字

5. 保留：占6位，保留为今后使用。目前置为0

5. **6个控制位：**

      1.紧急 URG：当 URG=1，代表紧急指针字段有效，代表有紧急数据。此报文段需要尽快传送，优先级高。

      2.确认 ACK：当 ACK=1，确认号字段有效。**连接建立后的所有报文段都必须令 ACK=1**。

      3.推送 PSH：当 PSH=1，接收方收到报文后需尽快交付应用进程，不用等缓存满了再向上交付。

      4.复位 RST：当 RST=1，表明 TCP 连接中出现严重差错，需要释放连接再重新建立连接。

      5.同步 SYN：在连接建立时用来同步序号，SYN=1且ACK=0时，代表连接请求报文段。对方若同意，则应在响应的报文段中令SYN=ACK=1。因此**SYN为1代表连接请求或连接接收报文**

      6.终止 FIN：当 **FIN=1，表明发送方已发送完数据，并要求释放连接**。

   

6. **窗口**：占2个字节，窗口值是[0 , 2^16-1]。窗口指的是发送本报文段的一方自己的**接收窗口**。窗口值告诉对方：从本报文段首部中的确认号算起，**接收方当前允许对方发送的数据量（单位是字节）**，因为接收方的数据缓存空间有限。**窗口值作为接收方让发送方设置其发送窗口的依据**

   7.**窗口字段指出了现在允许对方发送的数据量，窗口值是经常在动态变化的**

   8.**检验和**：检验整个数据报（包括首部和数据部分）。和UDP一样，也要加上伪首部

   9.**紧急指针**，当 URG=1 时才有意义，指出本报文段中的紧急数据的字节数。即指出紧急数据的末尾在报文段中的位置，即使在窗口为 0 时也可以发送紧急数据。

  10.**选项**：长度可变，最长 40 字节。选项有**最大报文段长度 MSS**、窗口扩大选项、时间戳选项、选择确认选项等。

##### **最大报文段长度 MSS（maximum segment size）**

最大报文段长度 MSS 是每一个 TCP 报文段中的**数据字段的最大长度**，而不是整个 TCP 报文段的最大长度。

MSS太小的话，会导致网络利用率低。因为TCP首部和IP首部就至少有40字节了。**MSS应该尽可能大，只要在IP层不需要再分片就行**

MSS 并不是一个标准固定值，而是可以由连接双方各自确定的值，且两个传送方向可以有不同的 MSS 值。MSS 的值可能达到几千字节。

连接建立时，双方都把自己支持的 MSS 写入这个选项字段中，以后就按照这个值传送数据。

如果未填写这一选项，那么 MSS 的默认值是 536 字节长。

**窗口扩大选项**

TCP 中窗口字段长度是 16 位，因此最大的窗口大小是 64K 字节。但是对于卫星网络，因为传播时延和带宽都很大，为了获得高吞吐率就需要更大的窗口。

**时间戳选项**

时间戳选项字段中主要包括时间戳值字段和时间戳回送回答字段。

- 时间戳选项用来计算往返时间 RTT。发送方把发送报文时的时间放入时间戳字段，接收方在确认该报文时把时间戳字段值复制到它的时间戳回送回答字段中。这样发送方收到确认报文后就可以计算出 RTT 来。

- 时间戳选项用于处理TCP序号超过2^32的情况，可以用来**防止序号绕回PAWS**，因为 TCP 序号字段只有 32 位，序号值不能超过 2^32，所以**可能出现具有相同序号的报文段，时间戳可以用来区分这样的报文段。**

### 6、TCP可靠传输的实现

#### 以字节为单位的滑动窗口

TCP 使用**滑动窗口机制**，以字节为单位。假设A收到了B发来的确认报文段，图中为假设的窗口大小

![](D:\office\word\计算机基础\计算机网络\截图2\TCP的滑动窗口.jpg)

**发送窗口里的序号表示允许发送的序号**，**发送窗口后沿的后面部分表示已发送且已收到了确认**，这些数据不需要再保存。发送窗口前沿的前面部分表示不允许发送，因为接收方没有为他们保留临时存放的缓存空间

发送窗口的前沿一般会不断向前移动（也可能不动或后移），在对方通知窗口缩小就可能后移，但**TCP标准强烈不赞成**。当不动时，一是可能没收到新的确认；二是收到新的确认但对方通知的窗口缩小了，使得发送窗口前沿正好不动

发送窗口的后沿可能不动（没有收到新的确认）也可能**前移（收到了新的确认）**，不可能后移。

窗口越大，发送方就可以在收到对方确认之前连续发送更多的数据，传输效率会更高。但是接收方必须来得及处理这些收到的数据

接收方会**把接收窗口的值放到窗口字段中**发给发送方**，发送窗口的大小不能超过接收方传来的报文首部中的窗口字段值。**

接收方**发回的确认号是自己按序收到的数据的最高序号加1**。

##### **一个使用滑动窗口进行可靠传输的例子**

现在 A 发送了 11 个字节的数据（序号 31-41），如下图所示。这时发送窗口的状态需要三个指针来描述：P1 指向发送窗口的后沿，P2 指向允许发送但尚未发送的第一个字节，P3 指向发送窗口的前沿外即将进入发送窗口的字节。P2~P3 之间的部分又称**可用窗口**。

此时发送窗口内的数据包含已发送但未收到确认（P1-P2）的数据；允许发送但尚未发送的数据（P2-P3）两部分。

B的接收窗口大小是20，30号为止的数据是已经发送过确认，并且已经交付主机，因此B可以不再保留。上图中B收到了32和33号的数据，但是它们没有按序到达，因为31号数据没有收到（可能丢失或滞留在网络某处）。

**注：B只能对按序收到的数据中最高序号给出确认，因此B发送的确认报文段中的确认号仍然是31（即期望收到的序号），注意要按序收到**

![](D:\office\word\计算机基础\计算机网络\截图2\A发送11个字节.jpg)

##### 发送缓存和接收缓存

![](D:\office\word\计算机基础\计算机网络\截图2\缓存和窗口的关系.jpg)

**发送缓存暂时存放：**

- 发送应用程序传送给发送方TCP准备发送的数据
- TCP已经发送但尚未收到确认的数据

**发送窗口是发送缓存的一部分。**已被确认的的数据会被从发送缓存中删除，因此发送缓存和发送窗口的后沿是重合的。

发送应用程序必须控制写入缓存的速率，不能太快，否则填满发送缓存后就没有存放数据的空间了。

实际发送/接收缓存和窗口中的字节数是非常大的。

**接收缓存用来暂时存放：**

- 按序到达的、但尚未被接收应用程序读取的数据
- 未按序到达的数据

接收窗口是接收缓存的一部分。若收到的分组被检测出有差错，则要丢弃。

如果应用程序来不及读取收到的数据，接收缓存就会被填满，使接收窗口减小到 0，反之接收窗口会增大，但最大不能超过接收缓存的大小。

**注意**：

- 虽然A的发送窗口根据B的接收窗口设置，但同一时刻A的发送窗口并不总是和B的接收窗口一样大。因为通过网络传送窗口值需要经历一定的时间滞后（这个时间不确定）；另外发送方A还能根据网络的拥塞情况适当减小自己的发送窗口数值

- TCP 没有明确规定如何处理未按序到达的数据，但**通常是先临时存放在接收窗口中，等字节流中缺少的字节收到后再按序交付给上层的应用进程。**如果将这些数据丢弃，那么接收窗口的管理会简单，但是对网络资源的利用不利（发送方会重复传送较多的数据）
- TCP要求接收方必须有**累积确认**的功能，这样可以减小传输开销。接收方可以在合适的时候发送确认，也可以在自己有数据需要发送时将确认信息顺便**捎带**上

**累积确认注意两点：**

- 接收方不应过分推迟发送确认，否则会导致发送方不必要的重传，这样会浪费网络的资源。TCP标准规定确认推迟的时间不应超过0.5秒，若收到一连串具有最大长度的报文段，则必须每隔一个报文段就要发送一个确认
- 捎带确认实际上并不经常发生，因为大部分应用程序不同时在两个方向上发送数据

#### 超时重传时间RTO的选择

重传时间的选择是 TCP 最复杂的问题之一。

TCP下层是互联网环境，发送的报文段可能只经过一个高速率的局域网，也可能经过多个低速率网络，并且每个IP数据报所选择的路由可能不同。超时重传时间太短会引起很多报文段不必要的重传，使网络负荷增大；太长又会使得网络空闲时间增大，降低传输效率

TCP采用一种自适应算法，它记录一个报文段发出的时间和收到相应确认的时间。这两个时间之差就是**报文段的往返时间RTT。TCP保留了RTT的一个加权平均往返时间RTTs（也叫作平滑的往返时间，s是smoothed），因为进行加权平均，所以得出的结果更加平滑**

#### 选择确认SACK

若收到的报文段无差错，但是没有按序号，中间还缺少一些序号的数据，能不能设法只传送缺少的数据而不重传已经正确到达的数据？

**选择确认（selective ACK）**就是一种可行的处理方法

若要使用选择确认，那么在建立TCP连接时，要在TCP首部的选项中加上允许SACK选项，选项中最多只能指明4个字节块的边界信息，4个字节块有8个边界，一个边界需要4字节（序号有32位，需要4个字节），所以一共需要32个字节来描述。另外还需要两个字节来指明SACK选项和这个选项占用多少字节

SACK文档没有指明发送方应当怎样响应SACK，因此大多数实现还是重传所有数据块

### 7、TCP的流量控制

#### 利用滑动窗口实现流量控制

若发送方把数据发送得过快，接收方可能来不及接收，这就会造成数据的丢失。**流量控制（flow control）就是让发送方的发送速率不要太快，要让接收方来得及接收**。利用滑动窗口机制可以很方便地在TCP连接上实现对发送方的流量控制

接收方的窗口大小可以进行缩小，实现流量控制

**发送方的发送窗口不能超过接收方给出的窗口字段的数值。TCP的窗口单位是字节，不是报文段**

**死锁**

当接收方的接收窗口减小到 0（即不允许发送方再发送数据），发送方停止发送数据后，过了一段时间接收窗口恢复了一些，但是此时它发给发送方的报文在传送时丢失了，然后 A 就会一直等待 B 发送的非零窗口的通知，而 B 也一直等待 A 发送的数据。若此时没有其他措施，这种互相等待的死锁局面将一直延续下去

为了解决此问题，TCP为每个连接设有一个**持续计时器（persistence timer）**，只要TCP连接的一方收到对方的零窗口通知，就启动它。

若持续计时器设置的时间到期，就发送一个零窗口**探测报文段（仅携带1字节的数据）**，而对方就在确认这个探测报文段时给出了现在的窗口值。若窗口仍然是零，那么收到这个报文段的一方就重新设置持续计时器。若不是零，那么死锁的僵局就可以打破

#### 必须考虑传输效率

应用进程把数据传送到TCP的发送缓存后，剩下的发送任务就由TCP来控制。

**可以使用不同的机制控制TCP报文段的发送时机**：

- 只要缓存中存放的数据达到最大报文段长度MSS时，就组装成一个TCP报文段发送出去
- 由发送方的应用进程指明要求发送报文段，即TCP支持的**推送（push）**操作
- 发送方的一个计时器期限到了，这时将当前已有的缓存数据装入报文段（长度不能操作MSS）发送出去

但是如何控制TCP发送报文段的时机仍然是一个较为复杂的问题

##### **Nagle 算法**

TCP 的实现中广泛使用了 **Nagle 算法**：

1. 若发送应用进程把要发送的数据逐个字节地送到TCP的发送缓存，则发送方就把第一个数据字节先发送出去，将后面到达的字节都缓存起来。收到对第一个字节的确认后，再把发送缓存中的所有数据组装成一个报文段发送出去，同时继续对随后到达的数据进行缓存
2. 只有在收到对前一个报文段的确认后再继续发送下一个报文段。当数据到达较快而网络速率较慢时，用这样的方法可明显地减少所用的网络带宽
3. 当缓存中的数据达到发送窗口的一半大小或报文段的最大长度后，就立即发送一个报文段。这样可以有效提高网络的吞吐量

另一个问题是**糊涂窗口综合症（silly window syndrome）**，TCP接收方的缓存已满，但是应用进程一次只从中读取一个字节，然后向发送方发送确认，窗口设为1个字节（数据报为40字节）。接着发送方又发来1个字节的数据（数据报是41字节长），接收方再这样发回确认。这样下去网络的效率很低。

解决方式：让接收方等待一段时间，使得接收缓存已有足够空间容纳一个最长的报文段，或者等到接收缓存已有一半空闲的空间。出现这两种情况即可发出确认报文，并向发送方通知当前的窗口大小。另外发送方也不要发送太小的报文段，而是将数据累积成足够大的报文段，或达到接收方缓存空间的一半大小

### 8、TCP的拥塞控制

#### 拥塞控制的一般原理

在计算机网络中的链路容量（即带宽）、交换结点中的缓存和处理机等都是**网络的资源。**

**在某段时间，若对网络中某一资源的需求超过了该资源所能提供的可用部分，网络的性能就要变坏**。这种情况叫作**拥塞（congestion）**

网络拥塞往往是由许多因素引起的，结点缓存太小会使到达该结点的分组因为无存储空间暂存而丢弃；缓存太大会使分组均可在其缓存队列中排队，但是输出链路的容量和处理机速度并未提高，这会使排队等待时间增加，会导致超时重传。**任意增加一些资源，比如简单地扩大缓存的存储空间同样会造成网络资源的严重浪费，解决不了网络拥塞的问题**

**问题的实质是整个系统的各个部分不匹配，只有所有的部分都平衡了，问题才会得到解决。拥塞常常趋于恶化，拥塞引起的重传不会缓解网络的拥塞，反而会加剧拥塞**

**拥塞控制就是防止过多的数据注入到网络中，这样可以使网络中的路由器或链路不致过载。拥塞控制所要做的都有一个前提，就是网络能够承受现有的网络负荷。**

TCP 连接的端点只要迟迟收不到对方的确认信息，就猜想网络中某处可能出现了拥塞。

拥塞控制是一个全局性的过程，涉及到所有主机、路由器和降低网络传输性能有关的所有因素。相反，流量控制往往指点对点通信量的控制，是个端到端的问题（接收端来控制发送端，抑制发送端发送数据的速率）

#### 几种拥塞控制方法

TCP 的拥塞控制采取了**慢开始、拥塞避免、快重传、快恢复**四种算法。

这种方法是**基于窗口的拥塞控制**。发送方维持一个**拥塞窗口cwnd**，它的大小取决于网络的拥塞程度且动态变化。发送方让**自己的发送窗口等于拥塞窗口**（实际上发送窗口取拥塞窗口和接收窗口中的较小者）。

发送方控制拥塞窗口的原则是：只要网络中没有出现拥塞，就把拥塞窗口增大一些；但只要网络出现拥塞，就把拥塞窗口减小一些。只要发送方没有按时收到应当到达的确认报文，就可以猜想网络可能出现了拥塞

判断网络拥塞的依据是**出现超时**。当出现拥塞就使拥塞窗口减小，反之增大。

### 9、TCP的运输连接管理

TCP是面向连接的协议，运输连接是用来传送TCP报文的。运输连接有三个阶段：**连接建立、数据传送和连接释放**。运输连接的管理就是使运输连接的建立和释放都能正常进行

TCP连接的建立采用**客户服务器方式**，主动发起连接建立的应用进程叫作客户，被动等待连接建立的应用进程叫作服务器

#### TCP的连接建立

TCP 的连接开始前客户和服务器都会创建一个**传输控制块 TCB**，其中存储如 TCP 连接表、指向发送/接收缓存的指针、指向重传队列的指针等。连接释放后删除。

**三次握手建立TCP连接（three-way handshake）：**

A主动打开连接，B被动打开连接

![](D:\office\word\计算机基础\计算机网络\截图2\TCP连接的三次握手.jpg)

B的TCP服务器进程先创建TCB，准备接受客户进程的连接请求。然后服务器进程就处于LISTEN（收听）状态，等待客户的连接请求。

**连接请求报文**和**连接接受报文**段（即前面两个）都不能携带数据，但是**都消耗一个序号。**seq表示自己发送的序号，ack是确认号

TCP客户进程收到B的确认后，还要向B给出确认，即第三个报文段。此 **ACK 报文**段可以携带数据也可以不携带，**若不携带数据则不消耗序号**（即下一个数据报文段的序号和此报文序号相同，seq也是x+1）。这时TCP连接已经建立

SYN-SENT 表示同步已发送状态，SYN-RCVD 表示同步收到状态，ESTABLISHED 表示已连接状态。

**A再发送一次确认的原因：**

为了防止已失效的连接请求报文段突然又传送到了B，B认为这是新的连接请求，此时若不采用三次握手，B会发出确认建立连接，因而产生错误。

实际上A并没有发出新的建立连接的请求，因此不会向B发送数据。但B会一直等待A发送数据，白白浪费资源

采用三次握手可以防止这种情况的发生，这时A不会对B的确认发出确认，就不会建立连接

#### TCP的连接释放

TCP 的连接释放采用**四次挥手机制**。**任何一方**都可以在数据传送结束后发出连接释放的通知，等待对方确认后进入**半关闭状态**。当另一方也没有数据发送后，则发送连接释放通知，对方确认后完全关闭 TCP 连接。

![](D:\office\word\计算机基础\计算机网络\截图2\TCP释放连接的过程.jpg)

上图中客户A发起了**连接释放报文(FIN=1)**，此时A不再传送数据。但是服务器B可能还要传送数据，因此在发送一个 **ACK 报文**后，如果有数据传送A仍要接收

**当服务器B发送完数据，就发送连接释放报文，接着客户端对此确认，服务器收到确认后彻底关闭连接。**

TCP 规定：FIN 报文即使不携带数据，也要消耗一个序号。

**四次挥手的详细流程**

1. A 向 B 发送连接释放报文（FIN 报文）后进入 FIN-WAIT-1（终止等待1）状态。
2. B 收到连接释放报文后立即发出确认，然后 B 就进入了 CLOSE-WAIT（关闭等待）状态。TCP 服务器进程这时要通知高层应用进程，从 A 到 B 方向的连接已经释放了，TCP 连接实际上已经是半关闭状态。
3. A 收到 B 的确认后，就进入 FIN-WAIT-2（终止等待2）状态，等待 B 发出的连接释放报文段。
4. B 在发送确认报文后，如果没有数据要发送，应用进程就通知 TCP 释放连接，这时 B 会发送连接释放报文（FIN 报文）。如果 B 还要发送数据，就等发送完数据后再发送连接释放报文。这之后 B 进入 LAST-ACK（最后确认）状态
5. A 收到 B 的连接释放报文后，要再发送一个确认报文段（ACK 报文），然后进入**TIME-WAIT（时间等待）状态，此时TCP连接还没有释放掉**。A 必须经过时间等待器设置的 2MSL 后，进入 CLOSED 状态。
6. B 收到 A 的确认报文后也会进入 CLOSED 状态。B 会比 A 更早地结束连接。

**MSL 含义是最长报文段寿命**，RFC 建议是 2 分钟（工程上的考虑），实际一般小于等于 2 分钟，因此 TIME-WAIT 的时长一般小于等于 4 分钟。

**为什么A在TIME-WAIT状态必须等待2MSL时间？**

1、为了保证A发送的最后一个ACK报文段能够到达B，这个报文段可能丢失，导致B收不到此确认。这时B会超时重传这个FIN+ACK报文段，而A能够在2MSL时间内收到它，然后A再重传确认，重新启动2MSL计时器。

若没有这段等待时间，而是发完 ACK 报文后就立即释放连接，就无法收到 B 重传的 FIN 报文段，这样 B 就无法正常进入 CLOSED 状态。

2、防止已失效的连接请求报文段出现在本连接中。A在发送完最后一个ACK报文段后，再经过2MSL，就可以**使本连接持续的时间内所产生的所有报文段都从网络中消失。**

**保活计时器（keepalive timer）**

TCP 还会设置一个保活计时器。如果客户发生故障，服务器不再收到客户发来地数据，可以通过保活计时器来避免服务器白白等待。

保活计时器的工作方式：服务器每收到一次客户的数据，就重新设置保活计时器，通常是 2 小时。如果 2h没收到客户数据，服务器就发送一个探测报文段，之后每隔 75分钟发送一次。如果连续发送 10 个探测报文后客户仍没有响应，服务器就认为客户端出了故障，关闭当前的 TCP 连接。

## 六、应用层

应用层的协议多是基于客户-服务器方式。这里的客户和服务器都是**应用进程**。

### 1、域名系统DNS

#### 概述

域名系统DNS（domain name system）是因特网使用的命名系统，**用来将便于人们使用的机器名字转换为IP地址**。IP地址长度固定，而域名长度不固定，因此机器处理困难

DNS 是一个**联机分布数据库系统**，采用客户-服务器方式。由于是分布式的，即使单个计算机出现问题也不会影响整个DNS系统正常运行

DNS 使大多数名字在本地进行解析，只有少量解析要在互联网上通信，因此效率很高

域名到 IP 地址的解析是由分布在因特网上的**许多域名服务器共同完成的**。

**域名到 IP 地址的解析过程：**

1. 当某一应用进程需要解析域名，就调用**解析程序**，成为 DNS 的一个客户，**把待解析的域名放到 DNS 请求报文中，以 UDP 用户数据报（使用UDP是为了减少开销）**方式发给**本地域名服务器**。本地域名服务器查找域名后把对应的 IP 地址放在回答报文中返回。应用进程**获得 目的主机的IP 地址后即可进行通信**。
2. 如果本地域名服务器不能回答该请求，就向其他域名服务器请求，直至找到能够回答该请求的域名服务器为止，此时它就成为了客户。

#### 因特网的域名结构 

因特网采用层次树状结构的命名方法，任何一台连接在互联网上的**主机**或**路由器**都有**唯一的一个域名(domain name)。**

每一个域名由标号序列组成，各标号之间用点隔开。标号由**英文字母、数字和‘-’组成，不区分大小写，完整域名不超过 255 个字符。**

**顶级域名TLD(top level domain)写在最右边，级别最低的则在左边**

各级域名由其上一级的域名管理机构管理，顶级域名由 ICANN 管理。

顶级域名 TLD 包括：

1. **国家顶级域名**：**cn 为中国**，us 为美国，uk 为英国。
2. **通用顶级域名**：**com(公司企业), net(网络服务机构), org(非营利性组织), int(国际组织)**, edu(美国教育机构), gov(美国政府部门), mil(美国军事部门)。
3. *基础结构域名**：arpa，用于反向域名解析。*

ICANN已经批准新顶级域名，任何公司、机构都可以申请

我国的二级域名分为两类：

1. 类别域名：**com(企业)**, ac(科研机构), **edu**, **gov**, mil, net, org 等。
2. 行政区域名：适用于各省。如 bj 为北京。

#### 域名服务器

DNS采用划分区的方式避免由于域名服务器数量太多，使得域名系统的运行效率降低

**区(zone)就是一个服务器所负责管辖或有权限的范围，每个区中的所有节点必须连通。**每个区设置相应的**权限域名服务器，保存此区中所有主机的域名到IP地址的映射。区只能小于等于域**

每个域名服务器只对域名体系中的一部分进行管辖

![](D:\office\word\计算机基础\计算机网络\截图2\域名服务器.jpg)

**域名服务器**分为**根域名服务器**、**顶级域名服务器**、**权限域名服务器**和**本地域名服务器**。

1. 所有的根域名服务器都**包含所有的顶级域名服务器的域名和IP地址。**

2. 1. 根域名服务器是最重要的服务器，如果本地域名服务器无法解析域名，**首先求助于根域名服务器**。
   2. 因特网共有**13个不同IP地址**的根域名服务器，根域名服务器在全球有成百上千个，但是分布是很不均衡的。
   3. 根域名服务器使用了**任播技术**。IP数据报的终点是一组在不同地点的主机，但IP地址相同，IP数据报交付给离源点最近的一个主机

3. 顶级域名服务器：管理在该服务器注册的二级域名。

4. 权限域名服务器：负责一个区的域名服务器

5. **本地域名服务器**：**主机查询域名时首先询问本地域名服务器**，计算机属性中的 DNS 服务器就是本地域名服务器。

DNS域名服务器会将数据复制到几个服务器来保存，其中一个是主域名服务器，其他是辅助域名服务器。

**域名解析过程**

主机向本地域名服务器的查询是**递归查询。**当本地域名服务器查不到时，由本地域名服务器以客户身份发出查询请求而不是主机本身。

本地域名服务器向根域名服务器的查询是**迭代查询**，即当根域名服务器无法完成解析时，就把下一步应该查询的域名服务器告诉本地域名服务器。

为提高查询效率，域名服务器中采用了**高速缓存**，存放最近查询过的域名信息。

### 2、文件传送协议

#### FTP概述

**文件传送协议FTP**(file transfer protocol)是因特网中使用最广泛的文件传送协议

FTP提供交互式的访问，允许客户指明文件的类型和格式（比如是否使用ASCII码），允许文件具有存取权限

**文件传送协议 FTP** 使用 **TCP** 的可靠运输服务，**使用客户-服务器模式。一个FTP服务器进程可同时为多个客户进程提供服务**

**简单文件传送协议 TFTP** 使用 **UDP** 协议。

FTP 和 TFTP 都属于文件共享协议中的一大类：**复制整个文件**。特点是要存取一个文件，**就必须先获得一个本地的文件副本**。要修改文件，只能对文件副本进行修改，然后将修改后的文件副本传送回到原节点。

文件共享协议的另一大类是**联机访问**，多个程序同时对一个文件进行存取，操作系统提供对远地共享文件进行访问的服务，就和访问本地文件一样。操作系统中的文件系统提供对共享文件的**透明存取**。

#### FTP的基本工作原理

网络环境中的一项基本应用就是将文件从一台计算机中复制到另一台可能相距很远的计算机中

**FTP的主要功能是减少或消除在不同操作系统下处理文件的不兼容性**

**FTP 的服务器进程包括一个主进程和若干个从属进程：**

1. 主进程：负责接受新的请求。当主进程收到客户进程发来的连接请求后，将其交给从属进程进行处理。然后回到等待状态继续接受其他客户的请求。
2. 从属进程：负责处理单个请求。

服务器进程中的主进程和从属进程是并发执行的。

![](D:\office\word\计算机基础\计算机网络\截图2\FTP的工作流程.jpg)

注：为了简单，上图省略了服务器端的主进程

**文件传输功能的实现**

文件传输时，FTP 的客户和服务器之间会建立**两个并行的 TCP 连接：控制连接和数据连接**，其中控制连接在整个会话期间一直保持打开，数据连接用于传输文件。因此 **FTP 要使用两个端口号**。

两个连接对应服务器端的两个从属进程：控制进程和数据传送进程。

FTP 客户发送的传送请求通过控制连接发送给控制进程。然后**控制进程创建数据传送进程和数据连接**。

#### 简单文件传送协议TFTP

**简单文件传送协议（trivial file transfer protocol）很小且易于实现，它 使用 UDP 协议，也是客户-服务器方式**

TFTP 的主要优点是可用于 UDP 环境，TFTP代码所占的内存较小。但是它只支持文件传输而不支持交互，TFTP必须有自己的差错改正措施。

TFTP 采用了类似**停止等待协议**的**重传机制**。即发送一个文件块后就等待对方确认（确认时应指明所确认的块编号），规定时间内没有确认就重发数据。

### 3、远程终端协议TELNET

**远程终端协议 TELNET** 采用客户-服务器方式。能**将客户端的操作传到服务器端，然后将服务器端的输出返回到客户端屏幕**。这种服务是透明的，因此TELNET也叫作**终端仿真协议**。随着PC的功能越来越强，现在已经很少使用TELNET了

TELNET 采用 TCP 协议。

**TELNET 的服务器进程**

TELNET 的服务器进程类似 FTP，由主进程等待新的请求，并产生从属进程来处理每一个连接。

### 4、万维网WWW

#### 万维网概述

万维网并非某种特殊的计算机网络，**它是一个大规模的、联机式的信息储藏所，英文简称为Web**

**万维网用链接的方法**能非常方便地**从因特网上的一个站点访问到另一个站点（即链接到另一个站点）**

**超文本（hypertext）**是**包含指向其他文档的链接的文本**，一个超文本由多个信息源链接成，它是万维网的基础。超文本文档仅包含文本信息，**超媒体文档**扩充为包含图形、声音、视频等。

**万维网是一个分布式的超媒体系统，以客户-服务器方式工作**

Web 的客户程序（浏览器）向互联网中的服务器程序**发出请求**，服务器程序向客户程序送回客户所要的万维网文档，**页面就是在客户程序主窗口显示出的万维网文档。**

**万维网要处理的几个问题及解决方式：**

1. 如何标志分布在整个互联网上的**文档**：采用**统一资源定位符 URL**。
2. 用什么协议来实现万维网上的链接：采用**超文本传送协议 HTTP**。
3. 怎么实现创作不同风格的万维网文档：使用**超文本标记语言 HTML**。
4. 怎样使用户很方便地找到所需信息：通过搜索引擎实现。

####  统一资源定位符URL

URL是用来表示从因特网上得到的资源位置和访问这些资源的方法。 用来标志万维网上的各种文档，**每个文档有在互联网内唯一的URL**。

**URL 相当于是一个文件名在网络范围内的扩展，因此是指向互联网上任何可访问对象的一个指针**

由于访问不同对象所使用的协议不同，所以URL还指出读取某个对象时所使用的协议，一般形式（四个部分）：

**<协议>://<主机>:<端口>/<路径>**

1. 协议：指出采用何种协议来获取该万维网文档，一般为 http，其次为 ftp
2. 主机：即该主机的域名。
3. **端口：通常都省略掉**，HTTP 的默认端口号是 **80**。
4. 路径：有时可省略。

输入 URL 时协议和 www 都可以省略，浏览器会自动补上。**URL里面的字母不分大小写，为了看起来方便可以使用大写**

**使用 HTTP 的 URL**

HTTP 的默认端口号是 80，通常都省略掉了。

**当路径也省略掉，则 URL 指向互联网上的某个主页**，比如 http://www.buaa.edu.cn。

主页可以是：

1. 一个 WWW 服务器的最高级别的页面。
2. 某一个组织的一个定制的页面，从这个页面可以链接到本组织的其他站点。
3. 个人设计的 WWW 页面。

https://www.buaa.edu.cn/jgsz1/yxsz.htm 左边是一个 URL 链接，cn/ 右侧的为路径，最后的 .htm 表明这是一个 htlm 文档

#### 超文本传送协议HTTP

HTTP协议定义了浏览器（即客户进程）怎样向万维网服务器**请求万维网文档**，以及服务器怎么把文档传送给浏览器

HTTP是**面向事务（一系列的信息交换，它们是不可分割的整体）的应用层协议**，它是万维网上能够可靠交换文件的重要基础

万维网客户与服务器程序之间交互使用的协议是 HTTP 协议。万维网的客户就是浏览器

HTTP 本身是**无连接（交换HTTP报文之前不需要先建立HTTP连接）、无状态（同一客户第二次访问同一个服务器上的页面时，服务器的响应和第一次被访问时相同，假设此页面还没更新。）**的，使用可靠传输的 **TCP 协议**。

**无状态是因为服务器并不记得曾经访问过的客户**，也不记得为该客户曾经服务过多少次。HTTP的无状态特性简化了服务器的设计，使得服务器更容器支持大量并发的HTTP请求

##### **HTTP连接的建立与释放**

每个万维网网点都有一个服务器进程，它不断地监听 TCP 的端口 **80**，当发现有浏览器向它发来 TCP 的连接建立请求并建立连接后，浏览器就会发出浏览某个页面的请求，服务器接着返回所请求的页面作为响应。最后 TCP 连接释放。

注意这个过程：**首先建立 TCP 连接**，且该连接的**端口为 80**。客户会**把 HTTP 请求报文作为 TCP 连接三次握手中的第三个报文的数据**。然后服务器直接返回文档作为响应。

**HTTP/1.1**

HTTP/1.1 协议使用了**持续连接**。就是万维网服务器在发送响应后一段时间内仍保持这条连接，使同一客户和该服务器可以继续在这条连接上传送后续HTTP请求报文和响应报文，只要文档在同一服务器就行

HTTP/1.1 协议的持续连接有两种工作方式：

1. 非流水线方式：客户收到前一个响应后才能发下一个请求。缺点：服务器发送完一个对象后，TCP连接处于空闲状态，浪费服务器资源
2. 流水线方式：客户收到上一个响应之前就可以接着发新的请求。

##### **代理服务器**

**代理服务器（proxy server）是一种网络实体，**又称**万维网高速缓存（web cache）**，它把最近的一些请求和响应暂存在**本地磁盘中**。当新请求与暂存的请求相同，就返回暂存的响应。不需要再按URL去因特网访问资源

代理服务器可以在客户端或服务端工作，也可以在中间系统上工作。

比如某个校园网使用了代理服务器，当校园网中某个主机的浏览器请求服务时，先和代理服务器建立 TCP 连接并发出 HTTP 请求报文，如果代理服务器有所请求对象就返回这个对象，**如果没有，代理服务器就代表用户与源点服务器建立TCP连接并发送 HTTP 请求报文。 **

##### **HTTP 的报文结构**

HTTP 报文的每一个字段都是 **ASCII 码串，HTTP是面向文本的**。

HTTP 有请求报文和响应报文两类报文。

HTTP 报文由三部分组成：

1. **开始行**：用于区分是请求报文还是响应报文。

2. 1. **请求行**：包括方法（表明了请求报文的类型），**请求的 URL**，HTTP 的版本。
   2. 状态行：响应报文的第一行叫状态行，包括：HTTP 的版本，**状态码**，解释状态码的短语。

3. 首部行：用来说明浏览器、服务器或报文主体的一些信息。

4. 实体主体：请求报文一般不使用这个字段，响应报文可能会使用。

注意：HTTP 报文中，**请求行最后有一个 CRLF**，**其他所有首部之间也都有一个 CRLF**，**首部与实体主体之间有两个 CRLF**。

![](D:\office\word\计算机基础\计算机网络\截图2\HTTP报文段.jpg)

```
//请求报文的例子
GET /dir/index.htm HTTP/1.1   //请求行，这里使用了相对 URL
Host:www.buaa.edu.cn          //第一个首部行，给出了主机的域名
Connection:close              //告诉服务器发送完请求的文档后就可以释放连接。
User-Agent:Mozilla/5.0        //表明用户代理使用了火狐浏览器
Accept-Launguage:cn           //表明用户希望优先收到中文版本的文档
                              //请求报文的最后还有一个空行
```

![](D:\office\word\计算机基础\计算机网络\截图2\请求报文的方法.jpg)

**HTTP 响应报文的** **5 大类状态码：**

1. 1xx。表示通知信息，如请求收到了或正在处理。
2. 2xx。表示成功。
3. 3xx。表示重定向，如要完成请求还需要采取进一步的行动。如 HTTP/1.1 301 Moved Permanently。这时后面还会跟一个首部行表明新的 URL 地址：Location:http://www.buaa.edu.cn/dd/index.html
4. 4xx。表示客户的差错。如 Http/1.1 404 Not Found
5. 5xx。表示服务器的差错。

##### **在服务器上存放用户的信息**

HTTP 是无状态的。当有时想要保存一些信息，比如保存某网站的账号与密码，就需要采用 **Cookie 技术**。**万维网站点可以使用 Cookie 来跟踪用户**。

Cookie 的工作原理：当用户 A 浏览某网站，该网站的服务器就为 A 产生一个唯一的识别码，并存储在数据库中，接着在给 A 的响应报文中添加一个**字段名为Set-cookie，值为识别码的首部行**，浏览器收到此响应报文后把它**存储在自己的 Cookie 文件中（包括服务器主机名和识别码）**。

当继续浏览此网站时，每发送一个HTTP请求报文，浏览器就会从Cookie文件中取出这个网站的识别码，放到**HTTP请求报文的Cookie首部行中**

这样服务器就能够知道用户 A 什么时候访问了哪些页面。当 A 之后再次访问时，服务器可以识别出 A，这样就不需要用户 A 再次输入姓名，密码等。

#### 万维网的文档

要使任何一台计算机都能显示出任何一个万维网服务器上的页面，就必须解决页面制作的标准化问题。

**超文本标记语言HTML是一种制作万维网页面的标准语言，消除了不同计算机之间信息交流的障碍**

HTML 文档是一种可以使用任何文本编辑器创建的 **ASCII 码文件**。

HTML 文档一般以 .html 或 .htm 为后缀。

HTML 规定了链接的设置方法。链接一般显示为蓝色字且加上下划线，链接的终点是其他页面。

当链接指向的是本计算机中的文件，就是**本地链接**。

**其他语言**

**可扩展标记语言 XML** 和 HTML 很相似。但从设计宗旨而言，**XML 用于传输数据**，而 **HTML 用于显示数据**。

**可扩展超文本标记语言 XHTML** 是作为一种 XML 应用被重新定义的 HTML，将逐步取代 HTML。

**层叠样式表 CSS** 是一种样式表语言，用于为 HTML 文档定义布局。如规定在浏览器上显示的字体、颜色、边距等。

**静态文档**

万维网**静态文档**：文档创作完毕后就存放在万维网服务器中，在用户浏览过程中，内容不会变。

**动态文档**

**动态文档：**文档的内容是在浏览器访问万维网服务器时由应用程序动态创建的。每次访问用户看到的内容都是不一样的。

比如天气预报、股市行情等都要用动态文档。

动态文档和静态文档的差别主要在服务器一端。

通用网关接口 CGI 是一种标准，定义了动态文档如何创建。服务器端使用 **CGI 程序**来创建动态文档。

**脚本**指的是**被另一个程序而非处理器来解释或执行的程序**。JavaScript 等就是脚本语言。

**活动文档**

**活动文档**：可以使浏览器屏幕连续更新。

当浏览器请求一个活动文档，服务器直接返回**一段活动文档**程序的副本，使该程序副本在浏览器端运行。活动文档程序可以与用户直接交互，并可以连续地改变屏幕的显示。

#### 万维网的信息检索系统

搜索引擎是在万维网中进行搜索的工具，可以分为**全文检索引擎（百度、谷歌等）和分类目录搜索引擎（搜狐、新浪等门户网站）两大类。**

**全文检索搜索引擎的工作原理：**通过搜索软件（如爬虫程序）到各网站搜集信息，像蜘蛛爬行一样从一个网站连接到另一个网站，然后建立一个在线索引数据库。当用户查询时，就从已经建立的索引数据库中进行查询。

## 七、无线网络和移动网络

### 1、无线局域网WLAN

无线局域网WLAN（wireless local area network）可以分为两大类:

1. **有固定基础设施的无线局域网**：使用了预先建立起来的基站覆盖一定范围的固定地址，比如蜂窝移动通信网使用了电信公司建立的固定基站。

2. 1. **有固定基础设施的**无线局域网采用的是 **802.11系列协议**。固定基础设施是指预先建立起来的、能够覆盖一定地理范围的一批固定基站。比如蜂窝移动电话
   2. **无固定基础设施的无线局域网**：移动自组网络，比如蓝牙。

#### **IEEE 802.11**

无线以太网的标准是 802.11 系列协议，**使用 802.11 系列协议的局域网又称 Wi-Fi。**

**理解：**WLAN 表示无线局域网，Wi-Fi 表示采用 802.11 系列协议的局域网，因此 Wi-Fi 是一种局域网，且属于无线局域网。Wi-Fi 实际上已经成了 WLAN 的代名词。

802.11 无线以太网标准是用星形拓扑，其中心叫做**接入点 AP**，在 MAC 层使用 **CSMA/CA 协议**和**停止等待协议**。

802.11 规定无线局域网的最小构件是**基本服务集 BSS**。一个 BSS 包括一个基站和若干个移动站，接入点 AP 就是 BSS 内的基站。

所有的站在本 BSS 以内都可以直接通信，与其他站通信则要通过接入点 AP。

每个 AP 都有一个分配的名字，称为**服务集标识符 SSID**，它其实就是使用该 AP 的无线局域网的名字（**也就是 wifi 名字**）。

**理解：日常说的 wifi 路由器其实就是接入点 AP。**

一个 BSS 所覆盖的地理范围叫做一个基本服务区 BSA，直径一般不超过 100m。

**一个 BSS 可以是孤立的**，也可以通过接入点 AP 连到分配系统（DS），然后再连接到另一个基本服务集，构成扩展的服务集ESS

AP 与 AP 之间的连接是有线的。

**漫游**

当一个移动站从一个服务集**漫游**到了其他服务集的范围，就要选择一个接入点 AP 与之建立关联，建立关联后加入该 BSS。

移动站关联 AP 后，要通过该 AP 向该子网**发送 DHCP 发现报文以获取 IP 地址**。这之后，移动站就作为该 AP 子网的成员加入到了因特网中

移动站（手机、平板电脑等）通常选择信号最强的 AP 来连接，但是一个 AP 提供的信道是有限的，如果已经耗尽了，就只能连接其他 AP。

**移动站与 AP 间通信采用的协议就是 802.11 协议。**

现在的手机和电脑上都有内置的无线局域网适配器，它能够实现 802.11 的物理层和 MAC 层的功能。无线局域网一般采用了**加密方案 WPA 或 WPA2**，这时要加入该无线局域网就要输入密码。

#### 移动自组网络

无固定基础设施的无线局域网叫做**移动自组网络（ad hoc network）**。蓝牙就是一种自组网络。

移动自组网络没有基站，而是由一些处于平等状态的移动站相互通信组成的**临时网络**。

自组网络一般不和外界的其他网络相连接。

**无线传感器网络 WSN** 是一种近年来发展很快的移动自组网络。它由大量传感器结点通过无线通信技术构成。物联网 IoT 就是 WSN 的应用领域。

### 2、802.11局域网的MAC层协议

#### CSMA/CA协议

无线局域网中只要开始发送数据，就一定把整个帧发送完毕。一旦发生了碰撞，那么整个信道资源在这段时间就会浪费。因此无线局域网应当尽量减少碰撞的发生

CA表示collision avoidance，即碰撞避免。协议的设计是尽量减少碰撞发生的概率

1. **CSMA/CA**：载波监听多点接入/**碰撞避免**
2. **CSMA/CD**：**载波监听多点接入/碰撞检测**

802.11 无线以太网在 MAC 层使用 **CSMA/CA 协议和停止等待协议**。

使用停止等待协议是**因为无线信道的通信质量远不如有线信道，无线站点每通过无线局域网发送完一帧后要等到收到对方的确认帧后才能继续发送下一帧，这是链路层确认。**使用停止等待协议能**保证可靠传输。**

无线局域网中不能使用 CSMA/CD 协议，因为：无线局域网中不是所有的站点都能听见对方，因此无法实现碰撞检测。使用 CSMA/CA 协议是为了减小碰撞发生的概率。

802.11 的 MAC 层协议通过**协调功能**来确定基本服务集 BSS 中的各移动站**在什么时间**发送和接收数据。它包括两个子层：

1. **分布协调功能 DCF**：DCF 不采用中心控制，它在每一个结点使用 CSMA 机制的分布式接入算法，让各个移动站通过**争用信道**来获取发送权。DCF向上提供争用服务，802.11协议规定所有的实现都必须有DCF功能
2. **点协调功能 PCF：**PCF 是选项，它**用接入点 AP 集中控制**整个 BSS 内各移动站的活动，使用类似探询的方法将发送数据权轮流交给各个站，以避免碰撞发生。**对时间敏感的业务应该采用 PCF**。

### 3、蜂窝无线通信技术

蜂窝移动通信是小区制的移动通信，它把整个网络划分成许多小区（也就是蜂窝），每个小区设置一个基站。移动站的通信都必须通过基站完成。

使用蜂窝移动通信是与同一个蜂窝小区的其他用户**共享带宽**的，每个用户实际分配到的带宽是不确定的。

小区的组成像蜂窝一样，每个基站的发射功能要能够覆盖本小区，又不会太大以至干扰邻近小区。采用蜂窝结构可以最大化**频率复用（相隔一定距离的不同小区可采用相同的频率而不会相互干扰）**，下图只需要相邻的7个小区采用不同的频率就可以组成大量小区构成的蜂窝无线通信系统

![](D:\office\word\计算机基础\计算机网络\截图2\蜂窝通信系统重要组成构建.jpg)

#### 移动IP

用户带着电脑改变地理位置，离开原来的网络时，通过动态主机配置协议DHCP就能自动获取所需的IP地址

只要移动站的IP地址改变，TCP连接就必须先中断再重新建立。当计算机移动到外地，移动 IP 技术允许该计算机**仍保留原来的 IP 地址**。

移动IP就是要使得用户的移动性对上层的网络应用是透明的。

![](D:\office\word\计算机基础\计算机网络\截图2\永久地址和转交地址.jpg)

移动IP的概念如上图。一个移动站A必须有一个原始地址，即**永久地址或归属地址**，移动站原始连接到的网络叫作**归属网络，永久地址和归属网络的关联不会改变**

**归属代理**通常就是连接在归属网络上的路由器，但是它作为代理的特定功能是在应用层完成的。归属代理既是路由器，也是主机

移动站A移动到另一个地点，他所接入的网络称为**被访网络或外地网络**，被访网络中使用的代理叫作**外地代理，它通常也是连接在被访网络上的路由器（也充当主机）**

**外地代理的一个任务就是要为移动站A创建一个临时地址，也叫作转交地址。**转交地址的网络号必须和被访网络一致。**外地代理的另一个功能就是及时将移动站A的转交地址通知A的归属代理**

注：

转交地址是供移动站、归属代理和外地代理使用，应用程序都不使用这种转交地址

转交地址在因特网不具有唯一性，外地代理可以给好多移动站指派同样的转交地址，**因为外地代理发送数据报时直接使用移动站的MAC地址（移动站首次和外地代理通信时就记录下来）**，而不是使用地址解析协议ARP

有时移动站本身也可以充当外地代理，即移动站和外地代理是同一设备，**这时的转交地址叫作同址转交地址**

**一个通信的例子**

一个通信者 B 要与移动站 A 进行通信，B不知道A在哪里，但B可以使用A的永久地址作为它的目的地址。其步骤如下：

1. B 发送给 A 的数据报被A的归属代理截获（只有A离开归属网络时，归属代理才能截获发给A的数据报）
2. 归属代理把 B 发来的数据报再封装（使用了隧道技术），新的数据报的目的地址是 A 现在的转交地址，它被发送给被访网络中的外地代理。
3. 外地代理把收到的数据报拆封，取出 B 发送的原始数据发送给移动站A。A 收到 B 的数据报后也就知道了 B 的 IP 地址。
4. 如果 A 要回复 B，就使用自己的永久地址作为源地址，用 B 的 IP 地址为目的地址发送数据报。这时不再需要通过 A 的归属代理进行转发。

移动 IP 使用了几种协议：

1. **移动站到外地代理的协议：**移动站接入到被访网络时，要**向外地代理登记，获得临时的转交地址**。离开该被访网络时要注销此登记。
2. **外地代理到归属代理的登记协议**：外地代理向归属代理登记移动站的转交地址。离开被访网络时不需要注销，会被新的外地代理取代
3. **归属代理数据报封装协议**：将收到的发给移动站的数据报进行封装，以转交地址为新的目的地址。
4. **外地代理拆封协议：**收到数据报后拆封并发给移动站。

#### **蜂窝移动通信网中对移动用户的路由选择**

移动 IP 的路由选择有间接路由选择和直接路由选择。上述方法就是间接路由选择。直接路由选择需要使用通信者代理和锚外地代理。

移动交换中心维护了两个数据库：

1. 归属位置寄存器 HLR：类似归属代理的功能。
2. 来访用户位置寄存器 VLR：类似外地代理的功能。